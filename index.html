<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå‹•ç”»åºƒå‘Šã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ (ã‚»ãƒªãƒ•è‰²åˆ†ã‘ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Libraries for file parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.18/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #file-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }
        .thumbnail {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 0.5rem;
            text-align: center;
            background-color: #f9fafb;
        }
        .thumbnail span {
            font-size: 0.75rem;
            word-break: break-all;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        #result-image-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            background-color: #000;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        #result-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: opacity 0.5s linear;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">AIå‹•ç”»åºƒå‘Šã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
            <p class="text-gray-600 mt-2">ç”»åƒã‚„URLã‹ã‚‰ã€AIãŒåºƒå‘Šç”¨ã®æ›ã‘åˆã„å°æœ¬ã‚’è‡ªå‹•ä½œæˆã—ã¾ã™ã€‚</p>
        </header>

        <main class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
            <!-- Mode Selection -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-2xl font-bold">ã‚¹ãƒ†ãƒƒãƒ—1ï¼šç´ æã‚’é¸æŠ</h2>
                    <button id="import-csv-btn" class="bg-indigo-100 text-indigo-700 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-200 transition-all text-sm">
                        CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    </button>
                    <input type="file" id="csv-import-input" class="hidden" accept=".csv">
                </div>
                <div class="flex gap-4" id="mode-selector">
                    <label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer flex-1">
                        <input type="radio" name="mode" value="file" checked class="form-radio h-5 w-5 text-blue-600">
                        <span>ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä½œæˆ</span>
                    </label>
                    <label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer flex-1">
                        <input type="radio" name="mode" value="url" class="form-radio h-5 w-5 text-blue-600">
                        <span>URLã‹ã‚‰ä½œæˆ</span>
                    </label>
                </div>
            </div>

            <!-- File Input Section -->
            <div id="file-input-section">
                 <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xl font-bold">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</h3>
                    <button id="clear-files-btn" class="text-sm font-semibold text-red-600 hover:text-red-800 hidden">&times; ã™ã¹ã¦ã‚¯ãƒªã‚¢</button>
                </div>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:bg-gray-50" id="drop-zone">
                    <input type="file" id="file-upload" accept="image/*,.pdf,.docx,.xlsx" class="hidden" multiple>
                    <p id="upload-prompt">ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆç”»åƒ, PDF, Word, Excelï¼‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                    <div id="file-preview-container"></div>
                </div>
            </div>
            
            <!-- URL Input Section -->
            <div id="url-input-section" class="hidden">
                 <h3 class="text-xl font-bold mb-2">URLã‚’å…¥åŠ›</h3>
                 <input type="url" id="url-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="https://example.com">
            </div>

            <!-- Step 2: Scenario Atmosphere & Format -->
            <div class="mt-8 mb-8">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">ã‚¹ãƒ†ãƒƒãƒ—2ï¼šå°æœ¬ã®é›°å›²æ°—ã¨å½¢å¼</h2>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold text-gray-700">é›°å›²æ°—ã‚„å½¢å¼ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰:</label>
                    <div id="scenario-checkboxes" class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="å…ƒæ°—ãªå¾Œè¼©ã¨è½ã¡ç€ã„ãŸå…ˆè¼©ã®å¯¾è©±å½¢å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>å¾Œè¼©ã¨å…ˆè¼©ã®å¯¾è©±</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="å°‚é–€å®¶ãŒåˆå¿ƒè€…ã«è§£èª¬ã™ã‚‹å½¢å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>å°‚é–€å®¶ã«ã‚ˆã‚‹è§£èª¬</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚­ãƒ£ã‚¹ã‚¿ãƒ¼ãŒç´¹ä»‹ã™ã‚‹å½¢å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ãƒ‹ãƒ¥ãƒ¼ã‚¹é¢¨ã®ç´¹ä»‹</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="å‹äººåŒå£«ãŒæ„Ÿæƒ³ã‚’èªã‚Šåˆã†å½¢å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>å‹äººåŒå£«ã®ä¼šè©±</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="ãƒ¦ãƒ¼ãƒ¢ã‚¢ã‚’äº¤ãˆã¦é¢ç™½ã" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ãƒ¦ãƒ¼ãƒ¢ã‚¢ã‚’äº¤ãˆã‚‹</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="æœ¬éƒ¨ç¤¾å“¡ã¨ã‚¢ãƒ«ãƒã‚¤ãƒˆã®ä¼šè©±" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ç¤¾å“¡ã¨ãƒã‚¤ãƒˆã®ä¼šè©±</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="æœ€å¾Œã«ã‚ªãƒã‚’ã¤ã‘ã‚‹" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ã‚ªãƒã‚’ã¤ã‘ã‚‹</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒãƒãƒ³é¢¨ã®æ¼«æ‰å½¢å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒãƒãƒ³é¢¨</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="ãƒŠã‚¤ãƒ„é¢¨ã®æ¼«æ‰å½¢å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ãƒŠã‚¤ãƒ„é¢¨</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="åšå¤šè¯ä¸¸ãƒ»å¤§å‰é¢¨ã®æ¼«æ‰å½¢å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>èŠ±ä¸¸å¤§å‰é¢¨</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="ä¸­å·å®¶é¢¨ã®æ¼«æ‰å½¢å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ä¸­å·å®¶é¢¨</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="é–¢è¥¿å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>é–¢è¥¿å¼</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="ã‚ªãƒ¼ãƒ‰ãƒªãƒ¼é¢¨ã®æ¼«æ‰å½¢å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ã‚ªãƒ¼ãƒ‰ãƒªãƒ¼é¢¨</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="å¤èˆ˜ä¼ŠçŸ¥éƒã•ã‚“é¢¨ã®å®Ÿæ³å½¢å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>å¤èˆ˜ä¼ŠçŸ¥éƒé¢¨</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="å½¦éº»å‘‚ã•ã‚“é¢¨ã®é£Ÿãƒ¬ãƒå½¢å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>å½¦éº»å‘‚é¢¨</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="è³‘ã‚„ã‹ãªæ„Ÿã˜ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>è³‘ã‚„ã‹ãªæ„Ÿã˜ã§</span>
                        </label>
                         <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="1åˆ†ä»¥å†…ã§çŸ­ãã¾ã¨ã‚ã‚‹" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>1åˆ†ã§ã¾ã¨ã‚ã‚‹</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="3åˆ†ç¨‹åº¦ã§ã¾ã¨ã‚ã‚‹" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>3åˆ†ã§ã¾ã¨ã‚ã‚‹</span>
                        </label>
                    </div>
                </div>
                 <div>
                    <label for="speaker-count" class="block mb-2 font-semibold text-gray-700">è©±è€…ã®äººæ•°:</label>
                    <input type="number" id="speaker-count" value="2" min="1" max="5" class="w-24 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
            </div>

            <!-- Step 3: Specific Instructions (New) -->
            <div class="mt-8 mb-8">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">ã‚¹ãƒ†ãƒƒãƒ—3ï¼šã‚¢ãƒ”ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆã¨å…·ä½“çš„ãªæŒ‡ç¤º</h2>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold text-gray-700">å…·ä½“çš„ãªè¨´æ±‚ç‚¹ã‚’é¸æŠï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰:</label>
                    <div id="appeal-checkboxes" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-amber-50 bg-amber-50/30 border-amber-200">
                            <input type="checkbox" value="æ–°å•†å“ã§ã‚ã‚‹ã“ã¨ã‚’ã‚¢ãƒ”ãƒ¼ãƒ«ã—ã¦" class="form-checkbox h-5 w-5 text-amber-600">
                            <span class="font-medium text-amber-900">æ–°å•†å“ã‚’ã‚¢ãƒ”ãƒ¼ãƒ«</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-amber-50 bg-amber-50/30 border-amber-200">
                            <input type="checkbox" value="ä¾¡æ ¼ã®å®‰ã•ã‚„ãŠå¾—æ„Ÿï¼ˆãƒ—ãƒ©ã‚¤ã‚¹ï¼‰ã‚’ã—ã£ã‹ã‚Šå¼·èª¿ã—ã¦" class="form-checkbox h-5 w-5 text-amber-600">
                            <span class="font-medium text-amber-900">ä¾¡æ ¼ãƒ»ãŠå¾—æ„Ÿã‚’å¼·èª¿</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-green-50 bg-green-50/30 border-green-200">
                            <input type="checkbox" value="1ã¤è²·ã†ã¨1ã¤ã‚‚ã‚‰ãˆã‚‹ã€Œãƒ—ãƒ©ã‚¤ãƒã€ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã§ã‚ã‚‹ã“ã¨ã‚’ã—ã£ã‹ã‚Šã¨è¨´æ±‚ã—ã¦" class="form-checkbox h-5 w-5 text-green-600">
                            <span class="font-medium text-green-900">ãƒ—ãƒ©ã‚¤ãƒï¼ˆ1å€‹è²·ã†ã¨1å€‹ç„¡æ–™ï¼‰</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-red-50 bg-red-50/30 border-red-200">
                            <input type="checkbox" value="ç²—åˆ©ã‚„åŸä¾¡ã«é–¢ã™ã‚‹å†…éƒ¨æƒ…å ±ã¯çµ¶å¯¾ã«å°æœ¬ã«å«ã‚ãªã„ã§" class="form-checkbox h-5 w-5 text-red-600">
                            <span class="font-medium text-red-900">ç²—åˆ©ãƒ»åŸä¾¡ã¯å«ã‚ãªã„</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-amber-50 bg-amber-50/30 border-amber-200">
                            <input type="checkbox" value="æœŸé–“é™å®šãƒ»ä»Šã ã‘ã®ãƒãƒ£ãƒ³ã‚¹ã§ã‚ã‚‹ã“ã¨ã‚’å¼·èª¿ã—ã¦" class="form-checkbox h-5 w-5 text-amber-600">
                            <span class="font-medium text-amber-900">æœŸé–“é™å®šã‚’å¼·èª¿</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="SNSã§ã®è©•åˆ¤ã‚„å£ã‚³ãƒŸæƒ…å ±ã‚’äº¤ãˆã¦ç´¹ä»‹ã—ã¦" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>å£ã‚³ãƒŸãƒ»SNSåå¿œ</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="ãƒ¡ãƒ¼ã‚«ãƒ¼å…¬å¼ã‚µã‚¤ãƒˆã®æƒ…å ±ã‚‚ç››ã‚Šè¾¼ã‚“ã§èª¬æ˜ã—ã¦" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ãƒ¡ãƒ¼ã‚«ãƒ¼å…¬å¼æƒ…å ±</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="å…¬çš„æ©Ÿé–¢ã®ãƒ‡ãƒ¼ã‚¿ã‚„æƒ…å ±ã‚’å¼•ç”¨ã—ã¦ä¿¡é ¼æ€§ã‚’é«˜ã‚ã¦" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>å…¬çš„ãƒ‡ãƒ¼ã‚¿ãƒ»ä¿¡é ¼æ€§</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±¤ï¼ˆåˆå¿ƒè€…ã€ä¸»å©¦ãªã©ï¼‰ã«å‘¼ã³ã‹ã‘ã‚‹è¡¨ç¾ã‚’å…¥ã‚Œã¦" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¸ã®å‘¼æ›</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="ä»–ç¤¾è£½å“ã¨ã®é•ã„ã‚„ãƒ¡ãƒªãƒƒãƒˆã‚’éš›ç«‹ãŸã›ã¦" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ä»–ç¤¾ã¨ã®å·®åˆ¥åŒ–</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="ç‰¹å…¸ã‚„ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æƒ…å ±ã‚’å¼·èª¿ã—ã¦" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ç‰¹å…¸ãƒ»ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="å•†å“ã®ä½¿ã„æ–¹ã‚’å…·ä½“çš„ã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã•ã›ã¦" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ä½¿ã„æ–¹ã®ã‚¤ãƒ¡ãƒ¼ã‚¸</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="ãŠå®¢æ§˜ã®æ‚©ã¿ã«å¯„ã‚Šæ·»ã„ã€è§£æ±ºç­–ã¨ã—ã¦æç¤ºã—ã¦" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>æ‚©ã¿è§£æ±ºã®æç¤º</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-red-50 bg-red-50/30 border-red-200">
                            <input type="checkbox" value="æœ€å¾Œã«ã€Œæ¤œç´¢ã€ã‚„ã€Œã‚¯ãƒªãƒƒã‚¯ã€ã‚’å¼·ãä¿ƒã—ã¦" class="form-checkbox h-5 w-5 text-red-600">
                            <span class="font-medium text-red-900">æ¤œç´¢ãƒ»ã‚¯ãƒªãƒƒã‚¯ã‚’ä¿ƒã™</span>
                        </label>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="scenario-detail" class="block mb-2 font-semibold text-gray-700">ãã®ä»–ã®è‡ªç”±è¨˜è¿°ï¼ˆå…·ä½“çš„ãªè¦æœ›ãŒã‚ã‚Œã°ï¼‰:</label>
                    <textarea id="scenario-detail" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" rows="2" placeholder="ä¾‹ï¼šã€‡ã€‡ã¨ã„ã†ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚‚ç™»å ´ã•ã›ã¦ãã ã•ã„ã€‚ç‰¹ã«ã€Œå®‰å¿ƒæ„Ÿã€ã‚’é‡è¦–ã—ã¦ãã ã•ã„ã€‚"></textarea>
                </div>
            </div>

            <!-- Generate Button -->
            <div class="text-center">
                <button id="generate-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-all shadow-md text-lg disabled:bg-gray-400 disabled:cursor-not-allowed">
                    åºƒå‘Šç´ æã‚’ç”Ÿæˆ
                </button>
            </div>

            <!-- Loading Indicator -->
            <div id="loading" class="hidden flex-col items-center justify-center my-8">
                <div class="loader"></div>
                <p id="loading-text" class="mt-4 text-gray-600">AIãŒå°æœ¬ã‚’ç”Ÿæˆä¸­ã§ã™... (ç´„30ç§’ã‹ã‹ã‚Šã¾ã™)</p>
            </div>

            <!-- Result Section -->
            <div id="result-section" class="hidden mt-10">
                <h2 class="text-2xl font-bold mb-6 text-center">ğŸ‰ åºƒå‘Šç´ æãŒå®Œæˆã—ã¾ã—ãŸï¼ ğŸ‰</h2>
                
                <div class="bg-gray-50 p-6 rounded-lg">
                    <div id="result-image-container" class="hidden">
                        <img id="result-image" alt="åºƒå‘Šç”»åƒ">
                    </div>
                    <p id="image-counter" class="text-center text-gray-500 text-sm mt-2"></p>
                    <div class="mt-4">
                        <div id="voice-settings-container" class="mb-4 p-4 border rounded-lg bg-white">
                             <h3 class="text-xl font-bold mb-3">è©±è€…ã®è¨­å®š</h3>
                             <div id="voice-selectors" class="space-y-2"></div>
                        </div>
                        <h3 class="text-xl font-bold mb-3">ç”Ÿæˆã•ã‚ŒãŸå°æœ¬ï¼ˆç·¨é›†å¯èƒ½ï¼‰</h3>
                        <div id="script-editor" class="w-full p-3 border border-gray-300 rounded-lg bg-white space-y-2"></div>
                        <div class="mt-4 p-4 border rounded-lg bg-white">
                             <h3 class="text-xl font-bold mb-3">ãƒ„ãƒ¼ãƒ«</h3>
                             <div class="flex items-center gap-4 mb-4">
                                <select id="translate-language" class="w-full p-2 border rounded-md bg-white">
                                    <option value="English">è‹±èª</option>
                                    <option value="Chinese">ä¸­å›½èª</option>
                                    <option value="Korean">éŸ“å›½èª</option>
                                    <option value="Spanish">ã‚¹ãƒšã‚¤ãƒ³èª</option>
                                    <option value="French">ãƒ•ãƒ©ãƒ³ã‚¹èª</option>
                                    <option value="Vietnamese">ãƒ™ãƒˆãƒŠãƒ èª</option>
                                </select>
                                <button id="translate-btn" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-700 transition-all text-sm flex-shrink-0">ç¿»è¨³ã‚’å®Ÿè¡Œ</button>
                             </div>
                             <div class="flex gap-4">
                                <button id="play-full-ad-btn" class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-all shadow-md flex items-center justify-center text-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                                    ã“ã“ã‹ã‚‰å†ç”Ÿ
                                </button>
                                <button id="export-csv-btn" class="w-full bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-600 transition-all shadow-md flex items-center justify-center text-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                    CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Export Instructions -->
                <div class="mt-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                    <h3 class="text-xl font-bold mb-3 text-amber-900">éŸ³å£°ä»˜ãå‹•ç”»ã®ä¿å­˜æ–¹æ³• (Mac)</h3>
                    <ol class="list-decimal list-inside text-amber-800 space-y-2">
                        <li>ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§ <strong>ã€Œcommandã€+ã€Œshiftã€+ã€Œ5ã€</strong>ã‚’åŒæ™‚ã«æŠ¼ã—ã¾ã™ã€‚</li>
                        <li>è¡¨ç¤ºã•ã‚ŒãŸãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã§**ã€Œç”»é¢å…¨ä½“ã‚’åéŒ²ã€**ã‚’é¸ã³ã€**ã€ŒåéŒ²ã€**ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚</li>
                        <li>ã™ãã«ã€ã“ã®ã‚¢ãƒ—ãƒªã®**ã€Œåºƒå‘Šå…¨ä½“ã‚’å†ç”Ÿã€**ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚</li>
                        <li>åºƒå‘Šã®å†ç”ŸãŒçµ‚ã‚ã£ãŸã‚‰ã€ç”»é¢ä¸Šéƒ¨ã®â– ï¼ˆåœæ­¢ï¼‰ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦åéŒ²ã‚’çµ‚äº†ã—ã¾ã™ã€‚ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã«å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚Œã¾ã™ã€‚</li>
                    </ol>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // DOM Elements
        const fileUpload = document.getElementById('file-upload');
        const dropZone = document.getElementById('drop-zone');
        const filePreviewContainer = document.getElementById('file-preview-container');
        const uploadPrompt = document.getElementById('upload-prompt');
        const clearFilesBtn = document.getElementById('clear-files-btn');
        const scenarioCheckboxes = document.getElementById('scenario-checkboxes');
        const appealCheckboxes = document.getElementById('appeal-checkboxes'); // Step 3 checkboxes
        const scenarioDetail = document.getElementById('scenario-detail');
        const speakerCount = document.getElementById('speaker-count');
        const generateBtn = document.getElementById('generate-btn');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        const resultSection = document.getElementById('result-section');
        const resultImageContainer = document.getElementById('result-image-container');
        const resultImage = document.getElementById('result-image');
        const imageCounter = document.getElementById('image-counter');
        const scriptEditor = document.getElementById('script-editor');
        const playFullAdBtn = document.getElementById('play-full-ad-btn');
        const voiceSelectors = document.getElementById('voice-selectors');
        const modeSelector = document.getElementById('mode-selector');
        const fileInputSection = document.getElementById('file-input-section');
        const urlInputSection = document.getElementById('url-input-section');
        const urlInput = document.getElementById('url-input');
        const importCsvBtn = document.getElementById('import-csv-btn');
        const csvImportInput = document.getElementById('csv-import-input');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const translateLanguage = document.getElementById('translate-language');
        const translateBtn = document.getElementById('translate-btn');

        // App State
        let currentMode = 'file';
        let sourceFiles = [];
        let generatedDialogue = [];
        let japaneseVoices = [];
        let currentLineIndex = 0;
        let isPlaying = false;
        let characterVoices = {};
        let characterColors = {}; // For color-coding speakers
        let imageSlideshowInterval = null; // ã‚¹ãƒ©ã‚¤ãƒ‰ã‚·ãƒ§ãƒ¼ç”¨ã‚¿ã‚¤ãƒãƒ¼IDï¼ˆæœªå®£è¨€ãƒã‚°ä¿®æ­£ï¼‰
        const colors = ['#3b82f6', '#10b981', '#ef4444', '#f97316', '#8b5cf6']; // blue, green, red, orange, purple

        // Speech Synthesis Setup
        const synth = window.speechSynthesis;
        const prepareVoices = () => {
            japaneseVoices = synth.getVoices().filter(voice => voice.lang.startsWith('ja'));
        };
        synth.onvoiceschanged = prepareVoices;
        prepareVoices();

        // Mode Selector Logic
        modeSelector.addEventListener('change', (e) => {
            currentMode = e.target.value;
            if (currentMode === 'file') {
                fileInputSection.classList.remove('hidden');
                urlInputSection.classList.add('hidden');
            } else {
                fileInputSection.classList.add('hidden');
                urlInputSection.classList.remove('hidden');
            }
        });

        // File Upload Logic
        dropZone.addEventListener('click', () => fileUpload.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-blue-500', 'bg-blue-50'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('border-blue-500', 'bg-blue-50'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            if (e.dataTransfer.files.length > 0) handleFiles(e.dataTransfer.files);
        });
        fileUpload.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFiles(e.target.files); });
        
        async function handleFiles(files) {
            const newFiles = Array.from(files);
            
            for (const file of newFiles) {
                try {
                    const fileData = { name: file.name, type: file.type || '' };
                    if (file.type && file.type.startsWith('image/')) {
                        fileData.fileType = 'image';
                        fileData.base64 = await toBase64(file);
                    } else {
                        fileData.fileType = 'document';
                        fileData.text = await parseDocument(file);
                    }
                    sourceFiles.push(fileData);
                } catch (err) {
                    console.error('ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼:', file.name, err);
                    alert(`ã€Œ${file.name}ã€ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚${err.message || ''}`);
                }
            }
            updateFilePreviews();
        }

        function updateFilePreviews() {
            filePreviewContainer.innerHTML = '';
            if (sourceFiles.length > 0) {
                uploadPrompt.classList.add('hidden');
                clearFilesBtn.classList.remove('hidden');
            } else {
                uploadPrompt.classList.remove('hidden');
                clearFilesBtn.classList.add('hidden');
            }

            sourceFiles.forEach(file => {
                const preview = document.createElement('div');
                preview.className = 'thumbnail';
                if (file.fileType === 'image') {
                    const img = document.createElement('img');
                    img.src = file.base64;
                    img.className = 'w-full h-full object-cover rounded-md';
                    preview.appendChild(img);
                } else {
                    preview.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400 mb-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg><span>${file.name}</span>`;
                }
                filePreviewContainer.appendChild(preview);
            });
        }

        clearFilesBtn.addEventListener('click', () => {
            sourceFiles = [];
            updateFilePreviews();
            fileUpload.value = ''; 
        });

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        async function parseDocument(file) {
            const arrayBuffer = await file.arrayBuffer();
            if (file.type === 'application/pdf') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
                const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                let text = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(item => item.str).join(' ');
                }
                return text;
            } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                return result.value;
            } else if (file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') {
                const workbook = XLSX.read(arrayBuffer, {type: 'buffer'});
                let text = '';
                workbook.SheetNames.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    text += XLSX.utils.sheet_to_csv(worksheet);
                });
                return text;
            }
            return 'ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚';
        }

        // Generation Logic
        generateBtn.addEventListener('click', async () => {
            const isFileMode = currentMode === 'file' && sourceFiles.length > 0;
            const isUrlMode = currentMode === 'url' && urlInput.value;

            if (!isFileMode && !isUrlMode) {
                alert('ç´ æï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯URLï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // Warm up speech synthesis engine on user gesture
            synth.cancel(); // Clear any previous state
            synth.speak(new SpeechSynthesisUtterance(''));

            loading.classList.remove('hidden');
            loading.classList.add('flex');
            loadingText.textContent = isUrlMode ? 'URLã®å†…å®¹ã‚’èª­ã¿å–ã£ã¦ã„ã¾ã™...' : 'AIãŒå°æœ¬ã‚’ç”Ÿæˆä¸­ã§ã™...';
            resultSection.classList.add('hidden');
            generateBtn.disabled = true;
            try {
                const scriptText = await generateScript();
                const jsonMatch = scriptText.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error("AI response did not contain valid JSON.");
                const scriptData = JSON.parse(jsonMatch[0]);
                displayResults(scriptData);
            } catch (error) {
                console.error('Error:', error);
                const msg = error && error.message ? error.message : 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚AIãŒä¸å®Œå…¨ãªå¿œç­”ã‚’è¿”ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                alert(msg);
            } finally {
                loading.classList.add('hidden');
                loading.classList.remove('flex');
                generateBtn.disabled = false;
            }
        });

        // Gemini API Call
        const GEMINI_API_KEY = ""; // ã“ã“ã«APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„

        async function callGemini(parts) {
            if (!GEMINI_API_KEY || !GEMINI_API_KEY.trim()) {
                throw new Error("Gemini APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚³ãƒ¼ãƒ‰å†…ã® GEMINI_API_KEY ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚");
            }
            const payload = {
                contents: [{ parts: parts }],
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const result = await response.json();
            if (!response.ok) {
                const errMsg = result.error && result.error.message ? result.error.message : response.statusText;
                throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${errMsg}`);
            }
            if (result.candidates && result.candidates.length > 0) {
                const part = result.candidates[0].content.parts[0];
                if (!part || !part.text) throw new Error("APIå¿œç­”ã«ãƒ†ã‚­ã‚¹ãƒˆãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                return part.text;
            }
            if (result.promptFeedback && result.promptFeedback.blockReason) {
                throw new Error(`ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ: ${result.promptFeedback.blockReason}`);
            }
            throw new Error("API response was empty.");
        }

        async function generateScript() {
            const numSpeakers = speakerCount.value;
            
            // Collect Step 2: Atmosphere/Format
            const checkedScenarioCheckboxes = document.querySelectorAll('#scenario-checkboxes input[type="checkbox"]:checked');
            let scenarioPromptText = "ã€é›°å›²æ°—ãƒ»å½¢å¼ã€‘: " + Array.from(checkedScenarioCheckboxes).map(cb => cb.value).join('ã€');
            
            // Collect Step 3: Specific Appeals
            const checkedAppealCheckboxes = document.querySelectorAll('#appeal-checkboxes input[type="checkbox"]:checked');
            const appealText = Array.from(checkedAppealCheckboxes).map(cb => cb.value).join('ã€');
            if (appealText) {
                scenarioPromptText += `\nã€å…·ä½“çš„ãªè¨´æ±‚ãƒã‚¤ãƒ³ãƒˆã€‘: ${appealText}`;
            }

            // Collect Free Text Details
            const detailText = scenarioDetail.value.trim();
            if (detailText) {
                scenarioPromptText += `\nã€ãã®ä»–ã®è‡ªç”±è¨˜è¿°æŒ‡ç¤ºã€‘: ${detailText}`;
            }

            let prompt;
            const parts = [];

            const commonRules = `
# ãƒ«ãƒ¼ãƒ«
- ç™»å ´äººç‰©ã¯${numSpeakers}äººã«ã—ã¦ãã ã•ã„ã€‚
- æŒ‡å®šã•ã‚ŒãŸã€é›°å›²æ°—ãƒ»å½¢å¼ã€‘ã¨ã€è¨´æ±‚ãƒã‚¤ãƒ³ãƒˆã€‘ã‚’å³å¯†ã«å®ˆã£ã¦ãã ã•ã„ã€‚
- ç‰¹ã«ã€Œæ–°å•†å“ã‚¢ãƒ”ãƒ¼ãƒ«ã€ã‚„ã€Œä¾¡æ ¼å¼·èª¿ã€ãªã©ã®æŒ‡ç¤ºãŒã‚ã‚‹å ´åˆã¯ã€ã‚»ãƒªãƒ•ã®ä¸­ã§æ˜ç¢ºã«è¨€åŠã—ã¦ãã ã•ã„ã€‚
- å‡ºåŠ›ã¯å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã«å¾“ã£ã¦ãã ã•ã„ã€‚

{"dialogue": [{"character": "ç™»å ´äººç‰©1ã®åå‰", "line": "ã‚»ãƒªãƒ•1"}, {"character": "ç™»å ´äººç‰©2ã®åå‰", "line": "ã‚»ãƒªãƒ•2"}]}
            `;

            if (currentMode === 'url') {
                prompt = `æŒ‡å®šã•ã‚ŒãŸURLã®ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã®å†…å®¹ã‚’èª­ã¿å–ã‚Šã€ãã®å†…å®¹ã‚’è¦ç´„ã—ã¦ãã ã•ã„ã€‚ãã®å¾Œã€ãã®è¦ç´„ã¨ä»¥ä¸‹ã®ã‚·ãƒŠãƒªã‚ªæŒ‡ç¤ºã«åŸºã¥ã„ã¦ã€ç™»å ´äººç‰©${numSpeakers}äººã«ã‚ˆã‚‹é­…åŠ›çš„ãªä¼šè©±å½¢å¼ã®å°æœ¬ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚\n\n# URL\n${urlInput.value}\n\n# ã‚·ãƒŠãƒªã‚ªã®æŒ‡ç¤º\n${scenarioPromptText}\n${commonRules}`;
                parts.push({ text: prompt });
            } else { // file mode
                prompt = `ä»¥ä¸‹ã®ã€ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã€‘ã®å†…å®¹ã‚’æ³¨æ„æ·±ãåˆ†æã—ã€ãã‚Œã‚‰å…¨ã¦ã®æƒ…å ±ã‚’ç¶²ç¾…ã—ãŸã€ä¸€è²«æ€§ã®ã‚ã‚‹ä¼šè©±å°æœ¬ã‚’1ã¤ã ã‘ä½œæˆã—ã¦ãã ã•ã„ã€‚\n\n# ã‚·ãƒŠãƒªã‚ªã®æŒ‡ç¤º\n${scenarioPromptText}\n${commonRules}`;
                parts.push({ text: prompt });
                sourceFiles.forEach(file => {
                    if (file.fileType === 'image') {
                        parts.push({ inline_data: { mime_type: file.type, data: file.base64.split(',')[1] } });
                    } else {
                        parts.push({ text: `\n--- ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${file.name}ã€ã®å†…å®¹ ---\n${file.text}\n--- å†…å®¹ã“ã“ã¾ã§ ---` });
                    }
                });
            }
            
            const payload = {
                contents: [{ parts: parts }],
                generation_config: { "response_mime_type": "application/json" }
            };
            if (!GEMINI_API_KEY || !GEMINI_API_KEY.trim()) {
                throw new Error("Gemini APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚³ãƒ¼ãƒ‰å†…ã® GEMINI_API_KEY ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚");
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const result = await response.json();
            if (!response.ok) {
                const errMsg = result.error && result.error.message ? result.error.message : response.statusText;
                throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${errMsg}`);
            }
            if (result.candidates && result.candidates.length > 0) {
                const part = result.candidates[0].content.parts[0];
                if (!part || !part.text) throw new Error("APIå¿œç­”ã«ãƒ†ã‚­ã‚¹ãƒˆãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                return part.text;
            }
            if (result.promptFeedback && result.promptFeedback.blockReason) {
                throw new Error(`ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ: ${result.promptFeedback.blockReason}`);
            }
            throw new Error("API response was empty.");
        }

        // UI Display Logic
        function displayResults(data) {
            if (!data || !Array.isArray(data.dialogue) || data.dialogue.length === 0) {
                console.error('displayResults: ç„¡åŠ¹ãª dialogue ãƒ‡ãƒ¼ã‚¿', data);
                alert('å°æœ¬ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
                return;
            }
            generatedDialogue = data.dialogue;
            
            const imageSources = sourceFiles.filter(f => f.fileType === 'image');
            if (currentMode === 'file' && imageSources.length > 0) {
                resultImageContainer.classList.remove('hidden');
                resultImage.src = imageSources[0].base64;
                imageCounter.textContent = `ç”»åƒ 1 / ${imageSources.length}`;
            } else {
                resultImageContainer.classList.add('hidden');
                imageCounter.textContent = '';
            }
            
            setupVoiceSelectors();
            setupScriptEditor();
            resultSection.classList.remove('hidden');
        }

        function setupVoiceSelectors() {
            voiceSelectors.innerHTML = '';
            characterVoices = {};
            characterColors = {};
            const characters = [...new Set(generatedDialogue.map(item => item.character))];
            
            if (japaneseVoices.length === 0) {
                voiceSelectors.innerHTML = '<p class="text-red-500">åˆ©ç”¨å¯èƒ½ãªéŸ³å£°ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</p>';
                return;
            }

            characters.forEach((char, index) => {
                characterColors[char] = colors[index % colors.length];

                const selectorDiv = document.createElement('div');
                selectorDiv.className = 'flex items-center justify-between gap-4';
                
                const label = document.createElement('label');
                label.textContent = `${char}ã®å£°:`;
                label.className = 'font-semibold flex-shrink-0';
                label.style.color = characterColors[char];

                const select = document.createElement('select');
                select.className = 'w-full p-2 border rounded-md bg-white';
                
                japaneseVoices.forEach((voice, vIndex) => {
                    const option = document.createElement('option');
                    option.value = vIndex;
                    option.textContent = voice.name;
                    select.appendChild(option);
                });

                const initialIndex = index % japaneseVoices.length;
                select.value = String(initialIndex);
                characterVoices[char] = japaneseVoices[initialIndex];

                select.onchange = () => {
                    const idx = parseInt(select.value, 10);
                    characterVoices[char] = japaneseVoices[idx];
                };
                
                selectorDiv.appendChild(label);
                selectorDiv.appendChild(select);
                voiceSelectors.appendChild(selectorDiv);
            });
        }

        function setupScriptEditor() {
            scriptEditor.innerHTML = '';
            generatedDialogue.forEach((item, index) => {
                const color = characterColors[item.character] || '#374151'; // Fallback to a dark gray

                const lineDiv = document.createElement('div');
                lineDiv.className = 'flex items-center gap-2';

                const charInput = document.createElement('input');
                charInput.type = 'text';
                charInput.value = item.character;
                charInput.className = 'p-1 border-none rounded-md w-28 font-semibold text-white text-center';
                charInput.style.backgroundColor = color;
                charInput.setAttribute('data-index', index);
                charInput.setAttribute('data-type', 'character');

                const lineInput = document.createElement('input');
                lineInput.type = 'text';
                lineInput.value = item.line;
                lineInput.className = 'p-1 border rounded-md flex-grow';
                lineInput.style.borderLeft = `4px solid ${color}`;
                lineInput.setAttribute('data-index', index);
                lineInput.setAttribute('data-type', 'line');

                const copyButton = document.createElement('button');
                copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg>`;
                copyButton.className = 'bg-gray-200 hover:bg-gray-300 p-2 rounded-md transition';
                copyButton.onclick = () => {
                    const textToCopy = lineInput.value;
                    const textArea = document.createElement('textarea');
                    textArea.value = textToCopy;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);

                    const originalColor = copyButton.style.color;
                    copyButton.classList.add('text-green-500');
                    setTimeout(() => {
                        copyButton.classList.remove('text-green-500');
                    }, 1500);
                };

                lineDiv.appendChild(charInput);
                lineDiv.appendChild(lineInput);
                lineDiv.appendChild(copyButton);
                scriptEditor.appendChild(lineDiv);
            });
        }

        // Playback Logic
        playFullAdBtn.addEventListener('click', () => {
            if (isPlaying) {
                stopFullAd();
            } else {
                const activeElement = document.activeElement;
                let startingIndex = 0;
                if (activeElement && activeElement.parentElement.parentElement === scriptEditor && activeElement.hasAttribute('data-index')) {
                    startingIndex = parseInt(activeElement.getAttribute('data-index'), 10);
                }
                startFullAd(startingIndex);
            }
        });

        function parseScriptFromEditor() {
            const newDialogue = [];
            const lineDivs = scriptEditor.querySelectorAll('div');
            lineDivs.forEach(div => {
                const charInput = div.querySelector('input[data-type="character"]');
                const lineInput = div.querySelector('input[data-type="line"]');
                if (charInput && lineInput) {
                    newDialogue.push({
                        character: charInput.value,
                        line: lineInput.value
                    });
                }
            });
            return newDialogue;
        }
        
        async function startFullAd(startingIndex = 0) {
            generatedDialogue = parseScriptFromEditor();
            if (generatedDialogue.length === 0) return;
            
            isPlaying = true;
            playFullAdBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 00-1 1v2a1 1 0 001 1h6a1 1 0 001-1V9a1 1 0 00-1-1H7z" clip-rule="evenodd" /></svg>åœæ­¢ã™ã‚‹`;
            
            const imageSources = sourceFiles.filter(f => f.fileType === 'image');
            let imageIndex = 0;
            if (imageSlideshowInterval) clearInterval(imageSlideshowInterval);
            imageSlideshowInterval = null;
            if (currentMode === 'file' && imageSources.length > 1) {
                imageSlideshowInterval = setInterval(() => {
                    imageIndex = (imageIndex + 1) % imageSources.length;
                    resultImage.style.opacity = 0;
                    setTimeout(() => {
                        resultImage.src = imageSources[imageIndex].base64;
                        resultImage.style.opacity = 1;
                        imageCounter.textContent = `ç”»åƒ ${imageIndex + 1} / ${imageSources.length}`;
                    }, 500);
                }, 3000);
            }

            currentLineIndex = startingIndex;
            speakFullAd();
        }

        function stopFullAd() {
            isPlaying = false;
            synth.cancel();
            if (imageSlideshowInterval) {
                clearInterval(imageSlideshowInterval);
                imageSlideshowInterval = null;
            }
            playFullAdBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>ã“ã“ã‹ã‚‰å†ç”Ÿ`;
            const imageSources = sourceFiles.filter(f => f.fileType === 'image');
            if (currentMode === 'file' && imageSources.length > 0) {
                resultImage.src = imageSources[0].base64;
                resultImage.style.opacity = 1;
                imageCounter.textContent = `ç”»åƒ 1 / ${imageSources.length}`;
            }
        }

        function speakFullAd() {
            if (currentLineIndex >= generatedDialogue.length || !isPlaying) {
                stopFullAd();
                return;
            }
            const item = generatedDialogue[currentLineIndex];
            const utterance = new SpeechSynthesisUtterance(item.line);
            
            if (characterVoices[item.character]) {
                utterance.voice = characterVoices[item.character];
            } else {
                const firstVoice = japaneseVoices[0];
                if (firstVoice) utterance.voice = firstVoice;
            }
            
            utterance.onend = () => {
                currentLineIndex++;
                setTimeout(speakFullAd, 500);
            };
            utterance.onerror = (e) => {
                console.error('SpeechSynthesisUtterance.onerror', e, 'Skipping to next line.');
                currentLineIndex++;
                setTimeout(speakFullAd, 500);
            };
            synth.speak(utterance);
        }

        // CSV Import/Export Logic
        importCsvBtn.addEventListener('click', () => {
            csvImportInput.click();
        });

        csvImportInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const dialogue = parseCSV(text);
                
                // Clear inputs
                clearFilesBtn.click();
                urlInput.value = '';
                scenarioDetail.value = 'CSVã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ';
                
                // Display results
                displayResults({ dialogue });
                resultSection.scrollIntoView({ behavior: 'smooth' });
            };
            reader.readAsText(file);
        });

        exportCsvBtn.addEventListener('click', () => {
            const dialogue = parseScriptFromEditor();
            if (dialogue.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹å°æœ¬ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            const csvContent = generateCSV(dialogue);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'script.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(l => l.trim());
            const dialogue = [];
            // Skip header
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                const firstCommaIndex = line.indexOf(',');
                if (firstCommaIndex === -1) continue;
                
                const character = line.substring(0, firstCommaIndex).trim().replace(/"/g, '');
                let lineText = line.substring(firstCommaIndex + 1).trim();
                
                if (lineText.startsWith('"') && lineText.endsWith('"')) {
                    lineText = lineText.substring(1, lineText.length - 1).replace(/""/g, '"');
                }
                dialogue.push({ character, line: lineText });
            }
            return dialogue;
        }

        function generateCSV(dialogue) {
            let csvRows = ['"character","line"'];
            dialogue.forEach(item => {
                const character = `"${item.character.replace(/"/g, '""')}"`;
                const line = `"${item.line.replace(/"/g, '""')}"`;
                csvRows.push([character, line].join(','));
            });
            return csvRows.join('\n');
        }

        // Translate Logic
        translateBtn.addEventListener('click', async () => {
            const dialogue = parseScriptFromEditor();
            if (dialogue.length === 0) {
                alert('ç¿»è¨³ã™ã‚‹å°æœ¬ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            const targetLanguage = translateLanguage.value;
            const originalText = dialogue.map(d => `${d.character}: ${d.line}`).join('\n');
            
            loading.classList.remove('hidden');
            loading.classList.add('flex');
            loadingText.textContent = `${targetLanguage}ã«ç¿»è¨³ä¸­ã§ã™...`;
            translateBtn.disabled = true;

            try {
                const characters = [...new Set(dialogue.map(item => item.character))].join(', ');
                const prompt = `ä»¥ä¸‹ã®å°æœ¬ã‚’ã€${targetLanguage}ã€‘ã«ç¿»è¨³ã—ã¦ãã ã•ã„ã€‚ç™»å ´äººç‰©ã®åå‰ï¼ˆ${characters}ï¼‰ã¯å¤‰æ›´ã›ãšã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€Œç™»å ´äººç‰©: ã‚»ãƒªãƒ•ã€ã‚’ç¶­æŒã—ã¦ãã ã•ã„ã€‚\n\n${originalText}`;
                const translatedText = await callGemini([{ text: prompt }]);
                
                const translatedDialogue = translatedText.split('\n').filter(line => line.trim() !== '').map(line => {
                    const colonIndex = line.indexOf(':');
                    if (colonIndex === -1) return { character: '?', line: line.trim() };
                    return {
                        character: line.substring(0, colonIndex).trim(),
                        line: line.substring(colonIndex + 1).trim()
                    };
                });

                if (translatedDialogue.length === 0) {
                    throw new Error('ç¿»è¨³çµæœã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
                }
                displayResults({ dialogue: translatedDialogue });

            } catch (error) {
                console.error('Translation failed:', error);
                alert('ç¿»è¨³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            } finally {
                loading.classList.add('hidden');
                loading.classList.remove('flex');
                translateBtn.disabled = false;
            }
        });

    </script>
</body>
</html>
