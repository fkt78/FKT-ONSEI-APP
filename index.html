<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="AIåºƒå‘Šå°æœ¬">
    <title>AIå‹•ç”»åºƒå‘Šã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ (ã‚»ãƒªãƒ•è‰²åˆ†ã‘ç‰ˆ)</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Libraries for file parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.18/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #file-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }
        .thumbnail {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 0.5rem;
            text-align: center;
            background-color: #f9fafb;
        }
        .thumbnail span {
            font-size: 0.75rem;
            word-break: break-all;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        #result-image-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            background-color: #000;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        #result-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: opacity 0.5s linear;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">AIå‹•ç”»åºƒå‘Šã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
            <p class="text-gray-600 mt-2">ç”»åƒã‚„URLã‹ã‚‰ã€AIãŒåºƒå‘Šç”¨ã®æ›ã‘åˆã„å°æœ¬ã‚’è‡ªå‹•ä½œæˆã—ã¾ã™ã€‚</p>
        </header>

        <main class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
            <!-- Mode Selection -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-2xl font-bold">ã‚¹ãƒ†ãƒƒãƒ—1ï¼šç´ æã‚’é¸æŠ</h2>
                    <button id="import-csv-btn" class="bg-indigo-100 text-indigo-700 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-200 transition-all text-sm">
                        CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    </button>
                    <input type="file" id="csv-import-input" class="hidden" accept=".csv">
                </div>
                <div class="flex gap-4" id="mode-selector">
                    <label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer flex-1">
                        <input type="radio" name="mode" value="file" checked class="form-radio h-5 w-5 text-blue-600">
                        <span>ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä½œæˆ</span>
                    </label>
                    <label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer flex-1">
                        <input type="radio" name="mode" value="url" class="form-radio h-5 w-5 text-blue-600">
                        <span>URLã‹ã‚‰ä½œæˆ</span>
                    </label>
                </div>
            </div>

            <!-- File Input Section -->
            <div id="file-input-section">
                 <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xl font-bold">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</h3>
                    <button id="clear-files-btn" class="text-sm font-semibold text-red-600 hover:text-red-800 hidden">&times; ã™ã¹ã¦ã‚¯ãƒªã‚¢</button>
                </div>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:bg-gray-50" id="drop-zone">
                    <input type="file" id="file-upload" accept="image/*,.pdf,.docx,.xlsx" class="hidden" multiple>
                    <p id="upload-prompt">ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆç”»åƒ, PDF, Word, Excelï¼‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                    <div id="file-preview-container"></div>
                </div>
            </div>
            
            <!-- URL Input Section -->
            <div id="url-input-section" class="hidden">
                 <h3 class="text-xl font-bold mb-2">URLã‚’å…¥åŠ›</h3>
                 <input type="url" id="url-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="https://example.com">
            </div>

            <!-- Step 2: ä½•ã‚’ä½œã‚‹ã‹ -->
            <div class="mt-8 mb-8">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">ã‚¹ãƒ†ãƒƒãƒ—2ï¼šä½•ã‚’ä½œã‚Šã¾ã™ã‹ï¼Ÿ</h2>
                <div class="flex gap-4 mb-6">
                    <label class="flex items-center gap-2 p-4 border-2 rounded-lg cursor-pointer flex-1 hover:bg-blue-50 border-blue-200 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                        <input type="radio" name="output-mode" value="voice" checked class="form-radio h-5 w-5 text-blue-600">
                        <span class="font-semibold">éŸ³å£°ã‚’ä½œã‚‹</span>
                        <span class="text-sm text-gray-500">å°æœ¬ã‚’ç”Ÿæˆã—ã€éŸ³å£°ã§å†ç”Ÿãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</span>
                    </label>
                    <label class="flex items-center gap-2 p-4 border-2 rounded-lg cursor-pointer flex-1 hover:bg-amber-50 border-amber-200 has-[:checked]:border-amber-500 has-[:checked]:bg-amber-50">
                        <input type="radio" name="output-mode" value="poster" class="form-radio h-5 w-5 text-amber-600">
                        <span class="font-semibold">ãƒã‚¹ã‚¿ãƒ¼ã‚’ä½œã‚‹</span>
                        <span class="text-sm text-gray-500">ç”»åƒã‚’ç”Ÿæˆã—ã€ãƒã‚¹ã‚¿ãƒ¼ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</span>
                    </label>
                </div>
            </div>

            <!-- Voice flow: Step 2 scenario + Step 3 + Generate -->
            <div id="voice-flow" class="mt-8 mb-8">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">å°æœ¬ã®é›°å›²æ°—ã¨å½¢å¼</h2>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold text-gray-700">é›°å›²æ°—ã‚„å½¢å¼ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰:</label>
                    <div id="scenario-checkboxes" class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="å…ƒæ°—ãªå¾Œè¼©ã¨è½ã¡ç€ã„ãŸå…ˆè¼©ã®å¯¾è©±å½¢å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>å¾Œè¼©ã¨å…ˆè¼©ã®å¯¾è©±</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="å°‚é–€å®¶ãŒåˆå¿ƒè€…ã«è§£èª¬ã™ã‚‹å½¢å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>å°‚é–€å®¶ã«ã‚ˆã‚‹è§£èª¬</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚­ãƒ£ã‚¹ã‚¿ãƒ¼ãŒç´¹ä»‹ã™ã‚‹å½¢å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ãƒ‹ãƒ¥ãƒ¼ã‚¹é¢¨ã®ç´¹ä»‹</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="å‹äººåŒå£«ãŒæ„Ÿæƒ³ã‚’èªã‚Šåˆã†å½¢å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>å‹äººåŒå£«ã®ä¼šè©±</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="ãƒ¦ãƒ¼ãƒ¢ã‚¢ã‚’äº¤ãˆã¦é¢ç™½ã" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ãƒ¦ãƒ¼ãƒ¢ã‚¢ã‚’äº¤ãˆã‚‹</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="æœ¬éƒ¨ç¤¾å“¡ã¨ã‚¢ãƒ«ãƒã‚¤ãƒˆã®ä¼šè©±" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ç¤¾å“¡ã¨ãƒã‚¤ãƒˆã®ä¼šè©±</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="æœ€å¾Œã«ã‚ªãƒã‚’ã¤ã‘ã‚‹" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ã‚ªãƒã‚’ã¤ã‘ã‚‹</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒãƒãƒ³é¢¨ã®æ¼«æ‰å½¢å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒãƒãƒ³é¢¨</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="ãƒŠã‚¤ãƒ„é¢¨ã®æ¼«æ‰å½¢å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ãƒŠã‚¤ãƒ„é¢¨</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="åšå¤šè¯ä¸¸ãƒ»å¤§å‰é¢¨ã®æ¼«æ‰å½¢å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>èŠ±ä¸¸å¤§å‰é¢¨</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="ä¸­å·å®¶é¢¨ã®æ¼«æ‰å½¢å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ä¸­å·å®¶é¢¨</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="é–¢è¥¿å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>é–¢è¥¿å¼</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="ã‚ªãƒ¼ãƒ‰ãƒªãƒ¼é¢¨ã®æ¼«æ‰å½¢å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ã‚ªãƒ¼ãƒ‰ãƒªãƒ¼é¢¨</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="å¤èˆ˜ä¼ŠçŸ¥éƒã•ã‚“é¢¨ã®å®Ÿæ³å½¢å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>å¤èˆ˜ä¼ŠçŸ¥éƒé¢¨</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="å½¦éº»å‘‚ã•ã‚“é¢¨ã®é£Ÿãƒ¬ãƒå½¢å¼ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>å½¦éº»å‘‚é¢¨</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="è³‘ã‚„ã‹ãªæ„Ÿã˜ã§" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>è³‘ã‚„ã‹ãªæ„Ÿã˜ã§</span>
                        </label>
                         <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="1åˆ†ä»¥å†…ã§çŸ­ãã¾ã¨ã‚ã‚‹" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>1åˆ†ã§ã¾ã¨ã‚ã‚‹</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="3åˆ†ç¨‹åº¦ã§ã¾ã¨ã‚ã‚‹" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>3åˆ†ã§ã¾ã¨ã‚ã‚‹</span>
                        </label>
                    </div>
                </div>
                 <div>
                    <label for="speaker-count" class="block mb-2 font-semibold text-gray-700">è©±è€…ã®äººæ•°:</label>
                    <input type="number" id="speaker-count" value="2" min="1" max="5" class="w-24 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
            </div>

            <!-- Step 3: Specific Instructions (New) -->
            <div class="mt-8 mb-8">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">ã‚¹ãƒ†ãƒƒãƒ—3ï¼šã‚¢ãƒ”ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆã¨å…·ä½“çš„ãªæŒ‡ç¤º</h2>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold text-gray-700">å…·ä½“çš„ãªè¨´æ±‚ç‚¹ã‚’é¸æŠï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰:</label>
                    <div id="appeal-checkboxes" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-amber-50 bg-amber-50/30 border-amber-200">
                            <input type="checkbox" value="æ–°å•†å“ã§ã‚ã‚‹ã“ã¨ã‚’ã‚¢ãƒ”ãƒ¼ãƒ«ã—ã¦" class="form-checkbox h-5 w-5 text-amber-600">
                            <span class="font-medium text-amber-900">æ–°å•†å“ã‚’ã‚¢ãƒ”ãƒ¼ãƒ«</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-amber-50 bg-amber-50/30 border-amber-200">
                            <input type="checkbox" value="ä¾¡æ ¼ã®å®‰ã•ã‚„ãŠå¾—æ„Ÿï¼ˆãƒ—ãƒ©ã‚¤ã‚¹ï¼‰ã‚’ã—ã£ã‹ã‚Šå¼·èª¿ã—ã¦" class="form-checkbox h-5 w-5 text-amber-600">
                            <span class="font-medium text-amber-900">ä¾¡æ ¼ãƒ»ãŠå¾—æ„Ÿã‚’å¼·èª¿</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-green-50 bg-green-50/30 border-green-200">
                            <input type="checkbox" value="1ã¤è²·ã†ã¨1ã¤ã‚‚ã‚‰ãˆã‚‹ã€Œãƒ—ãƒ©ã‚¤ãƒã€ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã§ã‚ã‚‹ã“ã¨ã‚’ã—ã£ã‹ã‚Šã¨è¨´æ±‚ã—ã¦" class="form-checkbox h-5 w-5 text-green-600">
                            <span class="font-medium text-green-900">ãƒ—ãƒ©ã‚¤ãƒï¼ˆ1å€‹è²·ã†ã¨1å€‹ç„¡æ–™ï¼‰</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-red-50 bg-red-50/30 border-red-200">
                            <input type="checkbox" value="ç²—åˆ©ã‚„åŸä¾¡ã«é–¢ã™ã‚‹å†…éƒ¨æƒ…å ±ã¯çµ¶å¯¾ã«å°æœ¬ã«å«ã‚ãªã„ã§" class="form-checkbox h-5 w-5 text-red-600">
                            <span class="font-medium text-red-900">ç²—åˆ©ãƒ»åŸä¾¡ã¯å«ã‚ãªã„</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-amber-50 bg-amber-50/30 border-amber-200">
                            <input type="checkbox" value="æœŸé–“é™å®šãƒ»ä»Šã ã‘ã®ãƒãƒ£ãƒ³ã‚¹ã§ã‚ã‚‹ã“ã¨ã‚’å¼·èª¿ã—ã¦" class="form-checkbox h-5 w-5 text-amber-600">
                            <span class="font-medium text-amber-900">æœŸé–“é™å®šã‚’å¼·èª¿</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="SNSã§ã®è©•åˆ¤ã‚„å£ã‚³ãƒŸæƒ…å ±ã‚’äº¤ãˆã¦ç´¹ä»‹ã—ã¦" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>å£ã‚³ãƒŸãƒ»SNSåå¿œ</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="ãƒ¡ãƒ¼ã‚«ãƒ¼å…¬å¼ã‚µã‚¤ãƒˆã®æƒ…å ±ã‚‚ç››ã‚Šè¾¼ã‚“ã§èª¬æ˜ã—ã¦" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ãƒ¡ãƒ¼ã‚«ãƒ¼å…¬å¼æƒ…å ±</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="å…¬çš„æ©Ÿé–¢ã®ãƒ‡ãƒ¼ã‚¿ã‚„æƒ…å ±ã‚’å¼•ç”¨ã—ã¦ä¿¡é ¼æ€§ã‚’é«˜ã‚ã¦" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>å…¬çš„ãƒ‡ãƒ¼ã‚¿ãƒ»ä¿¡é ¼æ€§</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±¤ï¼ˆåˆå¿ƒè€…ã€ä¸»å©¦ãªã©ï¼‰ã«å‘¼ã³ã‹ã‘ã‚‹è¡¨ç¾ã‚’å…¥ã‚Œã¦" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¸ã®å‘¼æ›</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="ä»–ç¤¾è£½å“ã¨ã®é•ã„ã‚„ãƒ¡ãƒªãƒƒãƒˆã‚’éš›ç«‹ãŸã›ã¦" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ä»–ç¤¾ã¨ã®å·®åˆ¥åŒ–</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="ç‰¹å…¸ã‚„ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æƒ…å ±ã‚’å¼·èª¿ã—ã¦" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ç‰¹å…¸ãƒ»ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="å•†å“ã®ä½¿ã„æ–¹ã‚’å…·ä½“çš„ã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã•ã›ã¦" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>ä½¿ã„æ–¹ã®ã‚¤ãƒ¡ãƒ¼ã‚¸</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" value="ãŠå®¢æ§˜ã®æ‚©ã¿ã«å¯„ã‚Šæ·»ã„ã€è§£æ±ºç­–ã¨ã—ã¦æç¤ºã—ã¦" class="form-checkbox h-5 w-5 text-blue-600">
                            <span>æ‚©ã¿è§£æ±ºã®æç¤º</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-red-50 bg-red-50/30 border-red-200">
                            <input type="checkbox" value="æœ€å¾Œã«ã€Œæ¤œç´¢ã€ã‚„ã€Œã‚¯ãƒªãƒƒã‚¯ã€ã‚’å¼·ãä¿ƒã—ã¦" class="form-checkbox h-5 w-5 text-red-600">
                            <span class="font-medium text-red-900">æ¤œç´¢ãƒ»ã‚¯ãƒªãƒƒã‚¯ã‚’ä¿ƒã™</span>
                        </label>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="scenario-detail" class="block mb-2 font-semibold text-gray-700">ãã®ä»–ã®è‡ªç”±è¨˜è¿°ï¼ˆå…·ä½“çš„ãªè¦æœ›ãŒã‚ã‚Œã°ï¼‰:</label>
                    <textarea id="scenario-detail" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" rows="2" placeholder="ä¾‹ï¼šã€‡ã€‡ã¨ã„ã†ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚‚ç™»å ´ã•ã›ã¦ãã ã•ã„ã€‚ç‰¹ã«ã€Œå®‰å¿ƒæ„Ÿã€ã‚’é‡è¦–ã—ã¦ãã ã•ã„ã€‚"></textarea>
                </div>
            </div>

            <!-- Generate Button (Voice) -->
            <div class="text-center">
                <button id="generate-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-all shadow-md text-lg disabled:bg-gray-400 disabled:cursor-not-allowed">
                    åºƒå‘Šç´ æã‚’ç”Ÿæˆ
                </button>
            </div>
            </div>

            <!-- Poster flow -->
            <div id="poster-flow" class="mt-8 mb-8 hidden">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">ãƒã‚¹ã‚¿ãƒ¼ã®è¨­å®š</h2>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold text-gray-700">ãƒˆãƒ¼ãƒ³ãƒ»ãƒãƒŠãƒ¼ï¼ˆè¤‡æ•°å¯ï¼‰:</label>
                    <div id="poster-tone-checkboxes" class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-amber-50"><input type="checkbox" value="ãƒ•ã‚©ãƒ¼ãƒãƒ«ã§ä¸Šå“ãª" class="form-checkbox text-amber-600"><span>ãƒ•ã‚©ãƒ¼ãƒãƒ«</span></label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-amber-50"><input type="checkbox" value="ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã§è¦ªã—ã¿ã‚„ã™ã„" class="form-checkbox text-amber-600"><span>ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«</span></label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-amber-50"><input type="checkbox" value="ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§ä¿¡é ¼æ„Ÿã®ã‚ã‚‹" class="form-checkbox text-amber-600"><span>ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«</span></label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-amber-50"><input type="checkbox" value="ãƒãƒƒãƒ—ã§æ˜ã‚‹ã„" class="form-checkbox text-amber-600"><span>ãƒãƒƒãƒ—</span></label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-amber-50"><input type="checkbox" value="è½ã¡ç€ã„ãŸé›°å›²æ°—ã®" class="form-checkbox text-amber-600"><span>è½ã¡ç€ã„ãŸ</span></label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-amber-50"><input type="checkbox" value="å…ƒæ°—ã§æ´»åŠ›ã®ã‚ã‚‹" class="form-checkbox text-amber-600"><span>å…ƒæ°—</span></label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-amber-50"><input type="checkbox" value="é«˜ç´šæ„Ÿã®ã‚ã‚‹" class="form-checkbox text-amber-600"><span>é«˜ç´šæ„Ÿ</span></label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-amber-50"><input type="checkbox" value="ã‚·ãƒ³ãƒ—ãƒ«ã§ãƒŸãƒ‹ãƒãƒ«ãª" class="form-checkbox text-amber-600"><span>ã‚·ãƒ³ãƒ—ãƒ«</span></label>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold text-gray-700">å¼·èª¿ã—ãŸã„ã“ã¨ï¼ˆè¤‡æ•°å¯ï¼‰:</label>
                    <div id="poster-emphasis-checkboxes" class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-amber-50"><input type="checkbox" value="æ–°å•†å“ãƒ»æ–°ã‚µãƒ¼ãƒ“ã‚¹" class="form-checkbox text-amber-600"><span>æ–°å•†å“</span></label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-amber-50"><input type="checkbox" value="ä¾¡æ ¼ãƒ»ãŠå¾—æ„Ÿ" class="form-checkbox text-amber-600"><span>ä¾¡æ ¼</span></label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-amber-50"><input type="checkbox" value="æœŸé–“é™å®š" class="form-checkbox text-amber-600"><span>æœŸé–“é™å®š</span></label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-amber-50"><input type="checkbox" value="å“è³ªãƒ»ã“ã ã‚ã‚Š" class="form-checkbox text-amber-600"><span>å“è³ª</span></label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-amber-50"><input type="checkbox" value="ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ»ä¿¡é ¼" class="form-checkbox text-amber-600"><span>ãƒ–ãƒ©ãƒ³ãƒ‰</span></label>
                        <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-amber-50"><input type="checkbox" value="ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ»ç‰¹å…¸" class="form-checkbox text-amber-600"><span>ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</span></label>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="poster-size" class="block mb-2 font-semibold text-gray-700">å‡ºåŠ›ã‚µã‚¤ã‚º:</label>
                    <select id="poster-size" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition">
                        <option value="3:4">A4ç¸¦ (3:4)</option>
                        <option value="4:3">A4æ¨ª (4:3)</option>
                        <option value="2:3">A3ç¸¦ (2:3)</option>
                        <option value="3:2">A3æ¨ª (3:2)</option>
                        <option value="1:1">1:1 (SNSãƒ»æ­£æ–¹å½¢)</option>
                        <option value="16:9">16:9 (æ¨ªé•·)</option>
                        <option value="9:16">9:16 (ç¸¦é•·)</option>
                    </select>
                </div>
                <div class="text-center">
                    <button id="generate-poster-btn" class="bg-amber-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-amber-600 transition-all shadow-md text-lg disabled:bg-gray-400 disabled:cursor-not-allowed">
                        ãƒã‚¹ã‚¿ãƒ¼ã‚’ç”Ÿæˆ
                    </button>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loading" class="hidden flex-col items-center justify-center my-8">
                <div class="loader"></div>
                <p id="loading-text" class="mt-4 text-gray-600">AIãŒå°æœ¬ã‚’ç”Ÿæˆä¸­ã§ã™... (ç´„30ç§’ã‹ã‹ã‚Šã¾ã™)</p>
            </div>

            <!-- Result Section -->
            <div id="result-section" class="hidden mt-10">
                <h2 class="text-2xl font-bold mb-6 text-center">ğŸ‰ åºƒå‘Šç´ æãŒå®Œæˆã—ã¾ã—ãŸï¼ ğŸ‰</h2>
                
                <div class="bg-gray-50 p-6 rounded-lg">
                    <div id="result-image-container" class="hidden">
                        <img id="result-image" alt="åºƒå‘Šç”»åƒ">
                    </div>
                    <p id="image-counter" class="text-center text-gray-500 text-sm mt-2"></p>
                    <div class="mt-4">
                        <div id="voice-settings-container" class="mb-4 p-4 border rounded-lg bg-white">
                             <h3 class="text-xl font-bold mb-3">è©±è€…ã®è¨­å®š</h3>
                             <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                                 <p class="font-semibold text-gray-700 mb-2">éŸ³å£°ã‚¨ãƒ³ã‚¸ãƒ³</p>
                                 <div class="flex flex-wrap items-center gap-4">
                                     <label class="flex items-center gap-2 cursor-pointer">
                                         <input type="radio" name="voice-engine" value="browser" checked class="form-radio text-blue-600">
                                         <span>ãƒ–ãƒ©ã‚¦ã‚¶ã®éŸ³å£°</span>
                                     </label>
                                     <label class="flex items-center gap-2 cursor-pointer">
                                         <input type="radio" name="voice-engine" value="voicevox" class="form-radio text-blue-600">
                                         <span>VOICEVOXï¼ˆãšã‚“ã ã‚‚ã‚“ç­‰ï¼‰</span>
                                     </label>
                                     <span id="voicevox-status" class="text-sm text-gray-500 hidden"></span>
                                 </div>
                                 <div id="voicevox-url-row" class="mt-2 hidden">
                                     <label class="text-sm text-gray-600">VOICEVOX Engine URLï¼ˆé€šå¸¸ã¯ãã®ã¾ã¾ã§OKï¼‰:</label>
                                     <input type="text" id="voicevox-engine-url" value="http://localhost:50021" class="mt-1 w-full max-w-md p-2 border border-gray-300 rounded text-sm">
                                 </div>
                             </div>
                             <div id="voice-selectors" class="space-y-2"></div>
                        </div>
                        <h3 class="text-xl font-bold mb-3">ç”Ÿæˆã•ã‚ŒãŸå°æœ¬ï¼ˆç·¨é›†å¯èƒ½ï¼‰</h3>
                        <p class="text-sm text-gray-600 mb-2">ä»»æ„ã®ä½ç½®ã«ã€Œä¸‹ã«ã‚»ãƒªãƒ•ã€ã§è¡Œã‚’æŒ¿å…¥ã—ã€ã‚­ãƒ£ãƒ©åã¨ã‚»ãƒªãƒ•ã‚’å…¥åŠ›ã™ã‚‹ã¨ãã®ãƒ¡ãƒ³ãƒãƒ¼ãŒèª­ã¿ä¸Šã’ã¾ã™ã€‚ä¸è¦ãªè¡Œã¯ã€Œå‰Šé™¤ã€ã§æ¶ˆã›ã¾ã™ã€‚</p>
                        <div id="script-editor" class="w-full p-3 border border-gray-300 rounded-lg bg-white space-y-2"></div>
                        <div class="mt-4 p-4 border rounded-lg bg-white">
                             <h3 class="text-xl font-bold mb-3">ãƒ„ãƒ¼ãƒ«</h3>
                             <div class="flex items-center gap-4 mb-4">
                                <select id="translate-language" class="w-full p-2 border rounded-md bg-white">
                                    <option value="English">è‹±èª</option>
                                    <option value="Chinese">ä¸­å›½èª</option>
                                    <option value="Korean">éŸ“å›½èª</option>
                                    <option value="Spanish">ã‚¹ãƒšã‚¤ãƒ³èª</option>
                                    <option value="French">ãƒ•ãƒ©ãƒ³ã‚¹èª</option>
                                    <option value="Vietnamese">ãƒ™ãƒˆãƒŠãƒ èª</option>
                                </select>
                                <button id="translate-btn" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-700 transition-all text-sm flex-shrink-0">ç¿»è¨³ã‚’å®Ÿè¡Œ</button>
                             </div>
                             <div class="flex flex-wrap gap-4">
                                <button id="play-full-ad-btn" class="flex-1 min-w-[140px] bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-all shadow-md flex items-center justify-center text-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                                    ã“ã“ã‹ã‚‰å†ç”Ÿ
                                </button>
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-sm font-medium text-gray-700">ä¿å­˜å½¢å¼:</span>
                                    <label class="inline-flex items-center gap-1 cursor-pointer"><input type="radio" name="download-format" value="wav" checked> WAV</label>
                                    <label class="inline-flex items-center gap-1 cursor-pointer"><input type="radio" name="download-format" value="mp4"> MP4</label>
                                </div>
                                <button id="download-full-audio-btn" class="flex-1 min-w-[140px] bg-emerald-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-emerald-700 transition-all shadow-md flex items-center justify-center text-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" clip-rule="evenodd" /></svg>
                                    éŸ³å£°ã‚’ã¾ã¨ã‚ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                </button>
                                <button id="export-csv-btn" class="flex-1 min-w-[140px] bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-600 transition-all shadow-md flex items-center justify-center text-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                    CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                                </button>
                            </div>
                            <!-- BGMã‚’ä»˜ã‘ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ -->
                            <div id="bgm-download-section" class="mt-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
                                <h4 class="font-bold text-gray-800 mb-3">BGMã‚’ä»˜ã‘ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h4>
                                <p class="text-sm text-gray-600 mb-3">VOICEVOXã§ä½œã£ãŸéŸ³å£°ã«BGMã‚’æ··ãœã¦1æœ¬ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ä¿å­˜ã§ãã¾ã™ï¼ˆä¸Šã§é¸æŠã—ãŸä¿å­˜å½¢å¼ï¼šWAV/MP4ï¼‰ã€‚BGMã¯éŸ³å£°ãŒé•·ã„é–“ãƒ«ãƒ¼ãƒ—å†ç”Ÿã•ã‚Œã€éŸ³å£°ã®çµ‚ã‚ã‚Šã«åˆã‚ã›ã¦ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã—ã¾ã™ã€‚</p>
                                <div class="flex flex-wrap items-end gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">BGMãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆMP3/WAVï¼‰</label>
                                        <input type="file" id="bgm-file-input" accept="audio/*" class="hidden">
                                        <button type="button" id="bgm-file-select-btn" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-md text-sm">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
                                        <span id="bgm-file-name" class="ml-2 text-sm text-gray-500">æœªé¸æŠ</span>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">BGMã®éŸ³é‡ <span id="bgm-volume-value">15</span>%</label>
                                        <input type="range" id="bgm-volume-slider" min="0" max="50" value="15" class="w-32">
                                    </div>
                                    <button type="button" id="download-with-bgm-btn" class="px-4 py-2 bg-amber-500 text-white font-bold rounded-lg hover:bg-amber-600 transition-all shadow flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" clip-rule="evenodd" /></svg>
                                        BGMã‚’ä»˜ã‘ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VOICEVOX åˆ©ç”¨æ™‚ -->
                <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h3 class="text-xl font-bold mb-3 text-blue-900">VOICEVOXï¼ˆãšã‚“ã ã‚‚ã‚“ç­‰ï¼‰ã‚’ä½¿ã†å ´åˆ</h3>
                    <p class="font-semibold text-blue-900 mb-2">ã€ŒåŒã˜PCã§ã‚¨ãƒ³ã‚¸ãƒ³ã‚’èµ·å‹•ã™ã‚‹ã€ã¨ã¯ï¼š</p>
                    <ol class="list-decimal list-inside text-blue-800 space-y-2 text-sm mb-3">
                        <li><strong>VOICEVOX</strong> ã‚’ <a href="https://voicevox.hiroshiba.jp/" target="_blank" rel="noopener" class="underline">å…¬å¼ã‚µã‚¤ãƒˆï¼ˆvoicevox.hiroshiba.jpï¼‰</a> ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€Mac ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚</li>
                        <li>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ <strong>VOICEVOX</strong> ã‚’èµ·å‹•ã—ã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã„ãŸã¾ã¾ã«ã—ã¾ã™ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å‹•ã„ã¦ã„ã‚Œã°OKï¼‰ã€‚</li>
                        <li>ã“ã®çŠ¶æ…‹ã§ã€ã“ã®ã‚¢ãƒ—ãƒªï¼ˆ<strong>http://localhost:9000</strong> ãªã©ï¼‰ã‚’<strong>åŒã˜ Mac</strong> ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã€ã€ŒéŸ³å£°ã‚¨ãƒ³ã‚¸ãƒ³ã€ã§ <strong>VOICEVOX</strong> ã‚’é¸ã¶ã¨ã€ãšã‚“ã ã‚‚ã‚“ç­‰ã®å£°ã§å†ç”Ÿã§ãã¾ã™ã€‚</li>
                    </ol>
                    <p class="text-blue-800 text-sm">â€» VOICEVOX ã‚’èµ·å‹•ã™ã‚‹ã¨ã€å†…éƒ¨ã§ Engine ãŒãƒãƒ¼ãƒˆ 50021 ã§å¾…ã¡å—ã‘ã¾ã™ã€‚åˆ¥ã® PC ã§ã“ã®ã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦ã„ã‚‹ã¨æ¥ç¶šã§ããªã„ãŸã‚ã€ã€ŒåŒã˜PCï¼ˆåŒã˜Macï¼‰ã§ã€VOICEVOX ã‚’èµ·å‹•ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
                </div>

                <!-- Export Instructions -->
                <div class="mt-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                    <h3 class="text-xl font-bold mb-3 text-amber-900">éŸ³å£°ä»˜ãå‹•ç”»ã®ä¿å­˜æ–¹æ³• (Mac)</h3>
                    <ol class="list-decimal list-inside text-amber-800 space-y-2">
                        <li>ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§ <strong>ã€Œcommandã€+ã€Œshiftã€+ã€Œ5ã€</strong>ã‚’åŒæ™‚ã«æŠ¼ã—ã¾ã™ã€‚</li>
                        <li>è¡¨ç¤ºã•ã‚ŒãŸãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã§**ã€Œç”»é¢å…¨ä½“ã‚’åéŒ²ã€**ã‚’é¸ã³ã€**ã€ŒåéŒ²ã€**ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚</li>
                        <li>ã™ãã«ã€ã“ã®ã‚¢ãƒ—ãƒªã®**ã€Œåºƒå‘Šå…¨ä½“ã‚’å†ç”Ÿã€**ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚</li>
                        <li>åºƒå‘Šã®å†ç”ŸãŒçµ‚ã‚ã£ãŸã‚‰ã€ç”»é¢ä¸Šéƒ¨ã®â– ï¼ˆåœæ­¢ï¼‰ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦åéŒ²ã‚’çµ‚äº†ã—ã¾ã™ã€‚ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã«å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚Œã¾ã™ã€‚</li>
                    </ol>
                </div>

                <!-- ã‚¢ãƒ—ãƒªã®ä»•æ§˜ -->
                <div class="mt-6 p-4 bg-slate-50 border border-slate-200 rounded-lg">
                    <button type="button" id="spec-toggle-btn" class="w-full text-left flex items-center justify-between font-bold text-slate-800 text-lg">
                        <span>ã‚¢ãƒ—ãƒªã®ä»•æ§˜</span>
                        <span id="spec-toggle-icon" class="text-slate-500">â–¼</span>
                    </button>
                    <div id="spec-content" class="hidden mt-4 text-sm text-slate-700 space-y-4">
                        <section>
                            <h4 class="font-bold text-slate-800 mb-1">æ¦‚è¦</h4>
                            <p>ç”»åƒãƒ»URLãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰AIï¼ˆGeminiï¼‰ã§å°æœ¬ã‚’ç”Ÿæˆã—ã€ãƒ–ãƒ©ã‚¦ã‚¶éŸ³å£°ã¾ãŸã¯VOICEVOXã§å†ç”Ÿã€‚CSVå…¥å‡ºåŠ›ãƒ»ç¿»è¨³ãƒ»è¡Œå˜ä½/å…¨ä½“ã®éŸ³å£°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ»BGMä»˜ããƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¯¾å¿œã€‚</p>
                        </section>
                        <section>
                            <h4 class="font-bold text-slate-800 mb-1">å°æœ¬ç·¨é›†</h4>
                            <ul class="list-disc list-inside space-y-1">
                                <li>ã€Œä¸‹ã«ã‚»ãƒªãƒ•ã€ï¼šãã®è¡Œã®ç›´ä¸‹ã«ã‚»ãƒªãƒ•è¡Œã‚’æŒ¿å…¥ï¼ˆã‚­ãƒ£ãƒ©åãƒ»ã‚»ãƒªãƒ•ã‚’å…¥åŠ›ã™ã‚‹ã¨ãã®ãƒ¡ãƒ³ãƒãƒ¼ãŒèª­ã¿ä¸Šã’ï¼‰ã€‚</li>
                                <li>ã€Œè¡Œã‚’è¿½åŠ ã€ï¼šæœ«å°¾ã«ã‚»ãƒªãƒ•è¡Œã‚’è¿½åŠ ã€‚</li>
                                <li>ã€Œå‰Šé™¤ã€ï¼šãã®è¡Œã‚’å‰Šé™¤ï¼ˆæœ€å¾Œã®1è¡Œã¯å‰Šé™¤ä¸å¯ï¼‰ã€‚</li>
                                <li>ã‚­ãƒ£ãƒ©åã¯è©±è€…ã®è¨­å®šã«åˆã‚ã›ã‚‹ã¨ã€ãã®å£°ã§å†ç”Ÿã•ã‚Œã‚‹ã€‚</li>
                            </ul>
                        </section>
                        <section>
                            <h4 class="font-bold text-slate-800 mb-1">éŸ³å£°</h4>
                            <ul class="list-disc list-inside space-y-1">
                                <li>ãƒ–ãƒ©ã‚¦ã‚¶ã®éŸ³å£°ï¼šå°æœ¬ã®ã‚­ãƒ£ãƒ©ã”ã¨ã«ãƒ–ãƒ©ã‚¦ã‚¶ã®æ—¥æœ¬èªéŸ³å£°ã‚’é¸æŠå¯èƒ½ã€‚</li>
                                <li>VOICEVOXï¼šåŒã˜PCã§VOICEVOX Engineï¼ˆlocalhost:50021ï¼‰ã‚’èµ·å‹•ã—ã€http://localhost:9000 ã§ã‚¢ãƒ—ãƒªã‚’é–‹ã„ãŸå ´åˆã«åˆ©ç”¨å¯èƒ½ã€‚ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼ˆHTTPSï¼‰ã§é–‹ã„ãŸå ´åˆã¯VOICEVOXã¯ä½¿ãˆãªã„ã€‚</li>
                                <li>éŸ³å£°ã‚’ã¾ã¨ã‚ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼šVOICEVOXé¸æŠæ™‚ã€å…¨è¡Œã‚’1æœ¬ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆä¿å­˜å½¢å¼ã§WAVã¾ãŸã¯MP4ã‚’é¸æŠå¯èƒ½ï¼‰ã€‚</li>
                                <li>BGMã‚’ä»˜ã‘ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼šVOICEVOXéŸ³å£°ã«BGMãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ··ãœã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆWAV/MP4é¸æŠå¯ï¼‰ã€‚BGMã¯ãƒ«ãƒ¼ãƒ—ã—ã€éŸ³å£°ã®çµ‚ã‚ã‚Šã§ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã€‚</li>
                            </ul>
                        </section>
                        <section>
                            <h4 class="font-bold text-slate-800 mb-1">APIãƒ»ãƒ‡ãƒ¼ã‚¿</h4>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Gemini APIã‚­ãƒ¼ï¼šç”»é¢ä¸Šã§å…¥åŠ›ãƒ»ä¿å­˜ï¼ˆlocalStorageï¼‰ã€‚å°æœ¬ç”Ÿæˆãƒ»ç¿»è¨³ã«ä½¿ç”¨ã€‚</li>
                                <li>CSVï¼šã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆcharacter,lineå½¢å¼ï¼‰ãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯¾å¿œã€‚</li>
                            </ul>
                        </section>
                        <section>
                            <h4 class="font-bold text-slate-800 mb-1">PWA</h4>
                            <p>ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¯èƒ½ã€‚å¸¸ã«æœ€æ–°ç‰ˆã§é–‹ããŸã‚ã€Service Workerã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å„ªå…ˆãƒ»æ›´æ–°æ™‚ãƒªãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿæ–½ã€‚</p>
                        </section>
                    </div>
                </div>
            </div>

            <!-- Poster Result Section -->
            <div id="result-section-poster" class="hidden mt-10">
                <h2 class="text-2xl font-bold mb-6 text-center">ğŸ‰ ãƒã‚¹ã‚¿ãƒ¼ãŒå®Œæˆã—ã¾ã—ãŸï¼ ğŸ‰</h2>
                <div class="bg-amber-50 p-6 rounded-lg border border-amber-200">
                    <div id="poster-image-container" class="mb-4 flex justify-center relative">
                        <canvas id="poster-canvas" class="hidden max-w-full rounded-lg shadow-lg"></canvas>
                        <img id="poster-result-image" alt="ç”Ÿæˆã•ã‚ŒãŸãƒã‚¹ã‚¿ãƒ¼" class="max-w-full rounded-lg shadow-lg">
                    </div>
                    <div class="mb-4 p-4 bg-white rounded-lg border border-amber-200">
                        <p class="text-sm text-gray-700 mb-2 font-semibold">è¡¨ç¤ºã™ã‚‹æ–‡è¨€ï¼ˆæ–‡å­—åŒ–ã‘å¯¾ç­–ãƒ»ä»»æ„ï¼‰</p>
                        <p class="text-xs text-gray-500 mb-2">ã“ã“ã«å…¥åŠ›ã—ãŸæ–‡è¨€ã‚’ãƒã‚¹ã‚¿ãƒ¼ã«é‡ã­ã¦è¡¨ç¤ºãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚AIãŒç”»åƒå†…ã«æã„ãŸæ–‡å­—ãŒåŒ–ã‘ã¦ã„ã‚‹å ´åˆã«ã”åˆ©ç”¨ãã ã•ã„ã€‚</p>
                        <div class="flex flex-wrap items-center gap-2">
                            <input type="text" id="poster-overlay-text" placeholder="ä¾‹ï¼šæœŸé–“é™å®šï¼" class="flex-1 min-w-[200px] p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                            <button type="button" id="poster-apply-overlay-btn" class="px-4 py-2 bg-amber-100 text-amber-800 font-semibold rounded-lg hover:bg-amber-200 transition">åæ˜ ã—ã¦è¡¨ç¤º</button>
                            <button type="button" id="poster-clear-overlay-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">ã‚¯ãƒªã‚¢</button>
                        </div>
                    </div>
                    <div class="text-center">
                        <button id="download-poster-btn" class="bg-amber-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-amber-600 transition-all shadow-md inline-flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" clip-rule="evenodd" /></svg>
                            ãƒã‚¹ã‚¿ãƒ¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // DOM Elements
        const fileUpload = document.getElementById('file-upload');
        const dropZone = document.getElementById('drop-zone');
        const filePreviewContainer = document.getElementById('file-preview-container');
        const uploadPrompt = document.getElementById('upload-prompt');
        const clearFilesBtn = document.getElementById('clear-files-btn');
        const scenarioCheckboxes = document.getElementById('scenario-checkboxes');
        const appealCheckboxes = document.getElementById('appeal-checkboxes'); // Step 3 checkboxes
        const scenarioDetail = document.getElementById('scenario-detail');
        const speakerCount = document.getElementById('speaker-count');
        const generateBtn = document.getElementById('generate-btn');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        const resultSection = document.getElementById('result-section');
        const resultImageContainer = document.getElementById('result-image-container');
        const resultImage = document.getElementById('result-image');
        const imageCounter = document.getElementById('image-counter');
        const scriptEditor = document.getElementById('script-editor');
        const playFullAdBtn = document.getElementById('play-full-ad-btn');
        const voiceSelectors = document.getElementById('voice-selectors');
        const modeSelector = document.getElementById('mode-selector');
        const fileInputSection = document.getElementById('file-input-section');
        const urlInputSection = document.getElementById('url-input-section');
        const urlInput = document.getElementById('url-input');
        const importCsvBtn = document.getElementById('import-csv-btn');
        const csvImportInput = document.getElementById('csv-import-input');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const downloadFullAudioBtn = document.getElementById('download-full-audio-btn');
        const translateLanguage = document.getElementById('translate-language');
        const translateBtn = document.getElementById('translate-btn');
        const bgmFileInput = document.getElementById('bgm-file-input');
        const bgmFileSelectBtn = document.getElementById('bgm-file-select-btn');
        const bgmFileName = document.getElementById('bgm-file-name');
        const bgmVolumeSlider = document.getElementById('bgm-volume-slider');
        const bgmVolumeValue = document.getElementById('bgm-volume-value');
        const downloadWithBgmBtn = document.getElementById('download-with-bgm-btn');
        const voiceFlow = document.getElementById('voice-flow');
        const posterFlow = document.getElementById('poster-flow');
        const resultSectionPoster = document.getElementById('result-section-poster');
        const posterResultImage = document.getElementById('poster-result-image');
        const posterCanvas = document.getElementById('poster-canvas');
        const posterOverlayText = document.getElementById('poster-overlay-text');
        const posterApplyOverlayBtn = document.getElementById('poster-apply-overlay-btn');
        const posterClearOverlayBtn = document.getElementById('poster-clear-overlay-btn');
        const generatePosterBtn = document.getElementById('generate-poster-btn');
        const downloadPosterBtn = document.getElementById('download-poster-btn');

        // App State
        let currentMode = 'file';
        let sourceFiles = [];
        let generatedDialogue = [];
        let japaneseVoices = [];
        let currentLineIndex = 0;
        let isPlaying = false;
        let characterVoices = {};
        let characterColors = {}; // For color-coding speakers
        let imageSlideshowInterval = null; // ã‚¹ãƒ©ã‚¤ãƒ‰ã‚·ãƒ§ãƒ¼ç”¨ã‚¿ã‚¤ãƒãƒ¼IDï¼ˆæœªå®£è¨€ãƒã‚°ä¿®æ­£ï¼‰
        const colors = ['#3b82f6', '#10b981', '#ef4444', '#f97316', '#8b5cf6']; // blue, green, red, orange, purple

        // VOICEVOX ç”¨
        let voicevoxSpeakers = []; // { id, displayName } ã®é…åˆ—ï¼ˆã‚¹ã‚¿ã‚¤ãƒ«å˜ä½ï¼‰
        let characterVoicevoxIds = {}; // ã‚­ãƒ£ãƒ©å -> VOICEVOX ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼IDï¼ˆã‚¹ã‚¿ã‚¤ãƒ«IDï¼‰
        let currentVoicevoxAudio = null; // å†ç”Ÿä¸­ã® Audioï¼ˆåœæ­¢ç”¨ï¼‰
        let lineAdvanceScheduled = false; // 1è¡Œã«ã¤ã1å›ã ã‘æ¬¡ã«é€²ã‚€ãŸã‚ã®ãƒ•ãƒ©ã‚°ï¼ˆå¥èª­ç‚¹ã§ onend ãŒè¤‡æ•°å›å‡ºã‚‹å¯¾ç­–ï¼‰
        let currentPosterDataUrl = null; // ãƒã‚¹ã‚¿ãƒ¼ç”»åƒã® Data URLï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰

        // éŸ³å£° / ãƒã‚¹ã‚¿ãƒ¼åˆ†å²
        document.querySelectorAll('input[name="output-mode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const isPoster = e.target.value === 'poster';
                voiceFlow.classList.toggle('hidden', isPoster);
                posterFlow.classList.toggle('hidden', !isPoster);
                resultSection.classList.add('hidden');
                resultSectionPoster.classList.add('hidden');
            });
        });

        // Speech Synthesis Setup
        const synth = window.speechSynthesis;
        const prepareVoices = () => {
            japaneseVoices = synth.getVoices().filter(voice => voice.lang.startsWith('ja'));
        };
        synth.onvoiceschanged = prepareVoices;
        prepareVoices();

        // Mode Selector Logic
        modeSelector.addEventListener('change', (e) => {
            currentMode = e.target.value;
            if (currentMode === 'file') {
                fileInputSection.classList.remove('hidden');
                urlInputSection.classList.add('hidden');
            } else {
                fileInputSection.classList.add('hidden');
                urlInputSection.classList.remove('hidden');
            }
        });

        // éŸ³å£°ã‚¨ãƒ³ã‚¸ãƒ³åˆ‡æ›¿ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ / VOICEVOXï¼‰
        document.querySelectorAll('input[name="voice-engine"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const isVoicevox = e.target.value === 'voicevox';
                document.getElementById('voicevox-url-row').classList.toggle('hidden', !isVoicevox);
                const statusEl = document.getElementById('voicevox-status');
                statusEl.classList.remove('hidden');
                if (isVoicevox) {
                    statusEl.textContent = 'VOICEVOX ã«æ¥ç¶šã—ã¦ã„ã¾ã™...';
                    fetchVoicevoxSpeakers().then(ok => {
                        statusEl.textContent = ok ? `VOICEVOX å¯¾å¿œï¼ˆ${voicevoxSpeakers.length} ç¨®é¡ã®å£°ï¼‰` : 'VOICEVOX ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚Engine ã‚’èµ·å‹•ã—ã¦ãã ã•ã„ã€‚';
                        statusEl.style.color = ok ? '#059669' : '#dc2626';
                        if (ok && voiceSelectors.innerHTML) setupVoiceSelectors();
                    }).catch(() => {
                        statusEl.textContent = 'VOICEVOX ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚Engine ã‚’èµ·å‹•ã—ã¦ãã ã•ã„ã€‚';
                        statusEl.style.color = '#dc2626';
                    });
                } else {
                    statusEl.textContent = '';
                    if (voiceSelectors.innerHTML) setupVoiceSelectors();
                }
            });
        });
        document.getElementById('voicevox-engine-url').addEventListener('change', () => {
            if (document.querySelector('input[name="voice-engine"]:checked').value === 'voicevox') {
                fetchVoicevoxSpeakers().then(ok => {
                    const statusEl = document.getElementById('voicevox-status');
                    statusEl.textContent = ok ? `VOICEVOX å¯¾å¿œï¼ˆ${voicevoxSpeakers.length} ç¨®é¡ã®å£°ï¼‰` : 'æ¥ç¶šã§ãã¾ã›ã‚“';
                    statusEl.style.color = ok ? '#059669' : '#dc2626';
                    if (ok && voiceSelectors.innerHTML) setupVoiceSelectors();
                });
            }
        });

        async function fetchVoicevoxSpeakers() {
            const base = document.getElementById('voicevox-engine-url').value.trim().replace(/\/$/, '');
            try {
                const res = await fetch(`${base}/speakers`);
                if (!res.ok) return false;
                const data = await res.json();
                voicevoxSpeakers = [];
                data.forEach(sp => {
                    (sp.styles || []).forEach(style => {
                        voicevoxSpeakers.push({
                            id: style.id,
                            displayName: `${sp.name}ï¼ˆ${style.name}ï¼‰`
                        });
                    });
                });
                return voicevoxSpeakers.length > 0;
            } catch (e) {
                console.warn('VOICEVOX fetch failed', e);
                return false;
            }
        }

        async function voicevoxSynthesize(text, speakerId) {
            const base = document.getElementById('voicevox-engine-url').value.trim().replace(/\/$/, '');
            const queryRes = await fetch(`${base}/audio_query?text=${encodeURIComponent(text)}&speaker=${speakerId}`, { method: 'POST' });
            if (!queryRes.ok) throw new Error('VOICEVOX audio_query failed');
            const query = await queryRes.json();
            const synthRes = await fetch(`${base}/synthesis?speaker=${speakerId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(query)
            });
            if (!synthRes.ok) throw new Error('VOICEVOX synthesis failed');
            const wavBlob = await synthRes.blob();
            return URL.createObjectURL(wavBlob);
        }

        // File Upload Logic
        dropZone.addEventListener('click', () => fileUpload.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-blue-500', 'bg-blue-50'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('border-blue-500', 'bg-blue-50'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            if (e.dataTransfer.files.length > 0) handleFiles(e.dataTransfer.files);
        });
        fileUpload.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFiles(e.target.files); });
        
        async function handleFiles(files) {
            const newFiles = Array.from(files);
            
            for (const file of newFiles) {
                try {
                    const fileData = { name: file.name, type: file.type || '' };
                    if (file.type && file.type.startsWith('image/')) {
                        fileData.fileType = 'image';
                        fileData.base64 = await toBase64(file);
                    } else {
                        fileData.fileType = 'document';
                        fileData.text = await parseDocument(file);
                    }
                    sourceFiles.push(fileData);
                } catch (err) {
                    console.error('ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼:', file.name, err);
                    alert(`ã€Œ${file.name}ã€ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚${err.message || ''}`);
                }
            }
            updateFilePreviews();
        }

        function updateFilePreviews() {
            filePreviewContainer.innerHTML = '';
            if (sourceFiles.length > 0) {
                uploadPrompt.classList.add('hidden');
                clearFilesBtn.classList.remove('hidden');
            } else {
                uploadPrompt.classList.remove('hidden');
                clearFilesBtn.classList.add('hidden');
            }

            sourceFiles.forEach(file => {
                const preview = document.createElement('div');
                preview.className = 'thumbnail';
                if (file.fileType === 'image') {
                    const img = document.createElement('img');
                    img.src = file.base64;
                    img.className = 'w-full h-full object-cover rounded-md';
                    preview.appendChild(img);
                } else {
                    preview.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400 mb-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg><span>${file.name}</span>`;
                }
                filePreviewContainer.appendChild(preview);
            });
        }

        clearFilesBtn.addEventListener('click', () => {
            sourceFiles = [];
            updateFilePreviews();
            fileUpload.value = ''; 
        });

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        async function parseDocument(file) {
            const arrayBuffer = await file.arrayBuffer();
            if (file.type === 'application/pdf') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
                const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                let text = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(item => item.str).join(' ');
                }
                return text;
            } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                return result.value;
            } else if (file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') {
                const workbook = XLSX.read(arrayBuffer, {type: 'buffer'});
                let text = '';
                workbook.SheetNames.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    text += XLSX.utils.sheet_to_csv(worksheet);
                });
                return text;
            }
            return 'ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚';
        }

        // Generation Logic
        generateBtn.addEventListener('click', async () => {
            const isFileMode = currentMode === 'file' && sourceFiles.length > 0;
            const isUrlMode = currentMode === 'url' && urlInput.value;

            if (!isFileMode && !isUrlMode) {
                alert('ç´ æï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯URLï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // Warm up speech synthesis engine on user gesture
            synth.cancel(); // Clear any previous state
            synth.speak(new SpeechSynthesisUtterance(''));

            loading.classList.remove('hidden');
            loading.classList.add('flex');
            loadingText.textContent = isUrlMode ? 'URLã®å†…å®¹ã‚’èª­ã¿å–ã£ã¦ã„ã¾ã™...' : 'AIãŒå°æœ¬ã‚’ç”Ÿæˆä¸­ã§ã™...';
            resultSection.classList.add('hidden');
            generateBtn.disabled = true;
            try {
                const scriptText = await generateScript();
                const jsonMatch = scriptText.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error("AI response did not contain valid JSON.");
                const scriptData = JSON.parse(jsonMatch[0]);
                displayResults(scriptData);
            } catch (error) {
                console.error('Error:', error);
                const msg = error && error.message ? error.message : 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚AIãŒä¸å®Œå…¨ãªå¿œç­”ã‚’è¿”ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                alert(msg);
            } finally {
                loading.classList.add('hidden');
                loading.classList.remove('flex');
                generateBtn.disabled = false;
            }
        });

        // ãƒã‚¹ã‚¿ãƒ¼ç”Ÿæˆ
        generatePosterBtn.addEventListener('click', async () => {
            if (!GEMINI_API_KEY || !GEMINI_API_KEY.trim()) {
                alert('Gemini APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚³ãƒ¼ãƒ‰å†…ã® GEMINI_API_KEY ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            let sourceSummary = '';
            if (currentMode === 'url') {
                if (!urlInput.value.trim()) {
                    alert('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                try {
                    loading.classList.remove('hidden');
                    loading.classList.add('flex');
                    loadingText.textContent = 'URLã®å†…å®¹ã‚’èª­ã¿å–ã£ã¦ã„ã¾ã™...';
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
                    const res = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `æ¬¡ã®URLã®ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã®å†…å®¹ã‚’è¦ç´„ã—ã€åºƒå‘Šãƒã‚¹ã‚¿ãƒ¼ã®ãƒ†ãƒ¼ãƒã¨ã—ã¦ä½¿ãˆã‚‹çŸ­ã„èª¬æ˜ï¼ˆæ—¥æœ¬èªãƒ»2ã€œ3æ–‡ï¼‰ã§è¿”ã—ã¦ãã ã•ã„ã€‚\nURL: ${urlInput.value.trim()}` }] }]
                        })
                    });
                    const data = await res.json();
                    if (data.candidates && data.candidates[0].content.parts[0].text) {
                        sourceSummary = data.candidates[0].content.parts[0].text.trim();
                    } else {
                        sourceSummary = 'ã“ã®URLã®å†…å®¹ã‚’å…ƒã«ã—ãŸåºƒå‘Š';
                    }
                } catch (e) {
                    console.error(e);
                    sourceSummary = 'ã“ã®URLã®å†…å®¹ã‚’å…ƒã«ã—ãŸåºƒå‘Š';
                }
            } else {
                if (sourceFiles.length === 0) {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹ã€URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    loading.classList.add('hidden');
                    loading.classList.remove('flex');
                    return;
                }
                const texts = sourceFiles.filter(f => f.text).map(f => f.text);
                sourceSummary = texts.length > 0 ? texts.join('\n').slice(0, 1500) : 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç´ æã‚’å…ƒã«ã—ãŸåºƒå‘Š';
            }

            const toneEls = document.querySelectorAll('#poster-tone-checkboxes input[type="checkbox"]:checked');
            const toneText = toneEls.length ? Array.from(toneEls).map(cb => cb.value).join('ã€') : 'ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸ';
            const emphasisEls = document.querySelectorAll('#poster-emphasis-checkboxes input[type="checkbox"]:checked');
            const emphasisText = emphasisEls.length ? Array.from(emphasisEls).map(cb => cb.value).join('ã€') : '';
            const aspectRatio = document.getElementById('poster-size').value;

            const imagePrompt = `Create a single, professional advertising poster image (Japanese-friendly design). 
Theme/source: ${sourceSummary}
Tone and manner: ${toneText}
${emphasisText ? `Emphasize: ${emphasisText}.` : ''}
IMPORTANT: Do NOT draw or render any text, letters, characters, or words in the image. No Japanese, no English, no numbers. Visual design only (illustration, colors, shapes, photos). Text will be added separately. Output only the image.`;

            const parts = [{ text: imagePrompt }];
            if (currentMode === 'file') {
                const imageFiles = sourceFiles.filter(f => f.fileType === 'image');
                for (const file of imageFiles.slice(0, 2)) {
                    parts.push({ inline_data: { mime_type: (file.base64 || '').match(/data:([^;]+)/)?.[1] || 'image/png', data: (file.base64 || '').split(',')[1] } });
                }
            }

            resultSectionPoster.classList.add('hidden');
            generatePosterBtn.disabled = true;
            loading.classList.remove('hidden');
            loading.classList.add('flex');
            loadingText.textContent = 'ãƒã‚¹ã‚¿ãƒ¼ã‚’ç”Ÿæˆä¸­ã§ã™... (æ•°åç§’ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™)';
            try {
                const modelId = 'gemini-2.5-flash-image';
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${GEMINI_API_KEY}`;
                const payload = {
                    contents: [{ parts }],
                    generationConfig: {
                        responseModalities: ['TEXT', 'IMAGE'],
                        imageConfig: {
                            aspectRatio: aspectRatio,
                            imageSize: '2K'
                        }
                    }
                };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                if (!response.ok) {
                    const errMsg = result.error && result.error.message ? result.error.message : response.statusText;
                    throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${errMsg}`);
                }
                let imageData = null;
                if (result.candidates && result.candidates[0].content.parts) {
                    for (const part of result.candidates[0].content.parts) {
                        if (part.inlineData && part.inlineData.data) {
                            const mime = part.inlineData.mimeType || 'image/png';
                            imageData = `data:${mime};base64,${part.inlineData.data}`;
                            break;
                        }
                    }
                }
                if (!imageData) {
                    throw new Error('ç”»åƒãŒè¿”ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®ãƒ¢ãƒ‡ãƒ«ã‚„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ãŠè©¦ã—ãã ã•ã„ã€‚');
                }
                currentPosterDataUrl = imageData;
                posterResultImage.src = imageData;
                posterOverlayText.value = '';
                posterCanvas.classList.add('hidden');
                posterResultImage.classList.remove('hidden');
                resultSectionPoster.classList.remove('hidden');
            } catch (error) {
                console.error(error);
                alert(error && error.message ? error.message : 'ãƒã‚¹ã‚¿ãƒ¼ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            } finally {
                loading.classList.add('hidden');
                loading.classList.remove('flex');
                generatePosterBtn.disabled = false;
            }
        });

        function drawPosterWithOverlay(imageDataUrl, text, canvasEl, onDone) {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => {
                canvasEl.width = img.naturalWidth;
                canvasEl.height = img.naturalHeight;
                const ctx = canvasEl.getContext('2d');
                ctx.drawImage(img, 0, 0);
                if (text && text.trim()) {
                    const fontSize = Math.max(32, Math.min(canvasEl.width, canvasEl.height) / 10);
                    ctx.font = `bold ${fontSize}px "Hiragino Sans", "Noto Sans JP", "Yu Gothic", sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    const x = canvasEl.width / 2;
                    const y = canvasEl.height * 0.85;
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = fontSize / 8;
                    ctx.strokeText(text.trim(), x, y);
                    ctx.fillStyle = '#fff';
                    ctx.fillText(text.trim(), x, y);
                }
                if (onDone) onDone();
            };
            img.onerror = () => { if (onDone) onDone(); };
            img.src = imageDataUrl;
        }

        posterApplyOverlayBtn.addEventListener('click', () => {
            const text = posterOverlayText.value.trim();
            if (!currentPosterDataUrl) return;
            if (!text) {
                posterCanvas.classList.add('hidden');
                posterResultImage.classList.remove('hidden');
                posterResultImage.src = currentPosterDataUrl;
                return;
            }
            drawPosterWithOverlay(currentPosterDataUrl, text, posterCanvas, () => {
                posterCanvas.classList.remove('hidden');
                posterResultImage.classList.add('hidden');
            });
        });

        posterClearOverlayBtn.addEventListener('click', () => {
            posterOverlayText.value = '';
            posterCanvas.classList.add('hidden');
            posterResultImage.classList.remove('hidden');
            posterResultImage.src = currentPosterDataUrl || '';
        });

        downloadPosterBtn.addEventListener('click', () => {
            if (!currentPosterDataUrl) return;
            const text = posterOverlayText.value.trim();
            let dataUrl = currentPosterDataUrl;
            if (text && posterCanvas.classList.contains('hidden')) {
                const img = new Image();
                img.onload = () => {
                    posterCanvas.width = img.naturalWidth;
                    posterCanvas.height = img.naturalHeight;
                    const ctx = posterCanvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    const fontSize = Math.max(32, Math.min(posterCanvas.width, posterCanvas.height) / 10);
                    ctx.font = `bold ${fontSize}px "Hiragino Sans", "Noto Sans JP", "Yu Gothic", sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    const x = posterCanvas.width / 2;
                    const y = posterCanvas.height * 0.85;
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = fontSize / 8;
                    ctx.strokeText(text, x, y);
                    ctx.fillStyle = '#fff';
                    ctx.fillText(text, x, y);
                    const out = posterCanvas.toDataURL('image/png');
                    const a = document.createElement('a');
                    a.href = out;
                    a.download = `poster_${Date.now()}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                };
                img.src = currentPosterDataUrl;
                return;
            }
            if (text && !posterCanvas.classList.contains('hidden')) {
                dataUrl = posterCanvas.toDataURL('image/png');
            }
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = `poster_${Date.now()}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

        // Gemini API Call
        const GEMINI_API_KEY = "AIzaSyDtf6N3IOF874fByFP77tcA1CG6WogEbDc"; // Gemini APIã‚­ãƒ¼

        async function callGemini(parts) {
            if (!GEMINI_API_KEY || !GEMINI_API_KEY.trim()) {
                throw new Error("Gemini APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚³ãƒ¼ãƒ‰å†…ã® GEMINI_API_KEY ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚");
            }
            const payload = {
                contents: [{ parts: parts }],
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const result = await response.json();
            if (!response.ok) {
                const errMsg = result.error && result.error.message ? result.error.message : response.statusText;
                throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${errMsg}`);
            }
            if (result.candidates && result.candidates.length > 0) {
                const part = result.candidates[0].content.parts[0];
                if (!part || !part.text) throw new Error("APIå¿œç­”ã«ãƒ†ã‚­ã‚¹ãƒˆãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                return part.text;
            }
            if (result.promptFeedback && result.promptFeedback.blockReason) {
                throw new Error(`ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ: ${result.promptFeedback.blockReason}`);
            }
            throw new Error("API response was empty.");
        }

        async function generateScript() {
            const numSpeakers = Math.max(1, Math.min(10, parseInt(speakerCount.value, 10) || 2));
            
            // Collect Step 2: Atmosphere/Format
            const checkedScenarioCheckboxes = document.querySelectorAll('#scenario-checkboxes input[type="checkbox"]:checked');
            let scenarioPromptText = "ã€é›°å›²æ°—ãƒ»å½¢å¼ã€‘: " + Array.from(checkedScenarioCheckboxes).map(cb => cb.value).join('ã€');
            
            // Collect Step 3: Specific Appeals
            const checkedAppealCheckboxes = document.querySelectorAll('#appeal-checkboxes input[type="checkbox"]:checked');
            const appealText = Array.from(checkedAppealCheckboxes).map(cb => cb.value).join('ã€');
            if (appealText) {
                scenarioPromptText += `\nã€å…·ä½“çš„ãªè¨´æ±‚ãƒã‚¤ãƒ³ãƒˆã€‘: ${appealText}`;
            }

            // Collect Free Text Details
            const detailText = scenarioDetail.value.trim();
            if (detailText) {
                scenarioPromptText += `\nã€ãã®ä»–ã®è‡ªç”±è¨˜è¿°æŒ‡ç¤ºã€‘: ${detailText}`;
            }

            let prompt;
            const parts = [];

            const commonRules = `
# ãƒ«ãƒ¼ãƒ«
- ç™»å ´äººç‰©ã¯${String(numSpeakers)}äººã«ã—ã¦ãã ã•ã„ã€‚
- æŒ‡å®šã•ã‚ŒãŸã€é›°å›²æ°—ãƒ»å½¢å¼ã€‘ã¨ã€è¨´æ±‚ãƒã‚¤ãƒ³ãƒˆã€‘ã‚’å³å¯†ã«å®ˆã£ã¦ãã ã•ã„ã€‚
- ç‰¹ã«ã€Œæ–°å•†å“ã‚¢ãƒ”ãƒ¼ãƒ«ã€ã‚„ã€Œä¾¡æ ¼å¼·èª¿ã€ãªã©ã®æŒ‡ç¤ºãŒã‚ã‚‹å ´åˆã¯ã€ã‚»ãƒªãƒ•ã®ä¸­ã§æ˜ç¢ºã«è¨€åŠã—ã¦ãã ã•ã„ã€‚
- å‡ºåŠ›ã¯å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã«å¾“ã£ã¦ãã ã•ã„ã€‚

{"dialogue": [{"character": "ç™»å ´äººç‰©1ã®åå‰", "line": "ã‚»ãƒªãƒ•1"}, {"character": "ç™»å ´äººç‰©2ã®åå‰", "line": "ã‚»ãƒªãƒ•2"}]}
            `;

            if (currentMode === 'url') {
                prompt = `æŒ‡å®šã•ã‚ŒãŸURLã®ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã®å†…å®¹ã‚’èª­ã¿å–ã‚Šã€ãã®å†…å®¹ã‚’è¦ç´„ã—ã¦ãã ã•ã„ã€‚ãã®å¾Œã€ãã®è¦ç´„ã¨ä»¥ä¸‹ã®ã‚·ãƒŠãƒªã‚ªæŒ‡ç¤ºã«åŸºã¥ã„ã¦ã€ç™»å ´äººç‰©${String(numSpeakers)}äººã«ã‚ˆã‚‹é­…åŠ›çš„ãªä¼šè©±å½¢å¼ã®å°æœ¬ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚\n\n# URL\n${urlInput.value}\n\n# ã‚·ãƒŠãƒªã‚ªã®æŒ‡ç¤º\n${scenarioPromptText}\n${commonRules}`;
                parts.push({ text: prompt });
            } else { // file mode
                prompt = `ä»¥ä¸‹ã®ã€ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã€‘ã®å†…å®¹ã‚’æ³¨æ„æ·±ãåˆ†æã—ã€ãã‚Œã‚‰å…¨ã¦ã®æƒ…å ±ã‚’ç¶²ç¾…ã—ãŸã€ä¸€è²«æ€§ã®ã‚ã‚‹ä¼šè©±å°æœ¬ã‚’1ã¤ã ã‘ä½œæˆã—ã¦ãã ã•ã„ã€‚\n\n# ã‚·ãƒŠãƒªã‚ªã®æŒ‡ç¤º\n${scenarioPromptText}\n${commonRules}`;
                parts.push({ text: prompt });
                sourceFiles.forEach(file => {
                    if (file.fileType === 'image') {
                        parts.push({ inline_data: { mime_type: file.type, data: file.base64.split(',')[1] } });
                    } else {
                        parts.push({ text: `\n--- ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${file.name}ã€ã®å†…å®¹ ---\n${file.text}\n--- å†…å®¹ã“ã“ã¾ã§ ---` });
                    }
                });
            }
            
            const payload = {
                contents: [{ parts: parts }],
                generation_config: { "response_mime_type": "application/json" }
            };
            if (!GEMINI_API_KEY || !GEMINI_API_KEY.trim()) {
                throw new Error("Gemini APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚³ãƒ¼ãƒ‰å†…ã® GEMINI_API_KEY ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚");
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const result = await response.json();
            if (!response.ok) {
                const errMsg = result.error && result.error.message ? result.error.message : response.statusText;
                throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${errMsg}`);
            }
            if (result.candidates && result.candidates.length > 0) {
                const part = result.candidates[0].content.parts[0];
                if (!part || !part.text) throw new Error("APIå¿œç­”ã«ãƒ†ã‚­ã‚¹ãƒˆãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                return part.text;
            }
            if (result.promptFeedback && result.promptFeedback.blockReason) {
                throw new Error(`ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ: ${result.promptFeedback.blockReason}`);
            }
            throw new Error("API response was empty.");
        }

        // UI Display Logic
        function displayResults(data) {
            if (!data || !Array.isArray(data.dialogue) || data.dialogue.length === 0) {
                console.error('displayResults: ç„¡åŠ¹ãª dialogue ãƒ‡ãƒ¼ã‚¿', data);
                alert('å°æœ¬ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
                return;
            }
            generatedDialogue = data.dialogue;
            
            const imageSources = sourceFiles.filter(f => f.fileType === 'image');
            if (currentMode === 'file' && imageSources.length > 0) {
                resultImageContainer.classList.remove('hidden');
                resultImage.src = imageSources[0].base64;
                imageCounter.textContent = `ç”»åƒ 1 / ${imageSources.length}`;
            } else {
                resultImageContainer.classList.add('hidden');
                imageCounter.textContent = '';
            }
            
            setupVoiceSelectors();
            setupScriptEditor();
            resultSection.classList.remove('hidden');
        }

        function setupVoiceSelectors() {
            voiceSelectors.innerHTML = '';
            characterVoices = {};
            characterVoicevoxIds = {};
            characterColors = {};
            const characters = [...new Set(generatedDialogue.map(item => item.character).filter(c => c != null && String(c).trim() !== ''))];
            const useVoicevox = document.querySelector('input[name="voice-engine"]:checked').value === 'voicevox';

            if (useVoicevox) {
                if (voicevoxSpeakers.length === 0) {
                    voiceSelectors.innerHTML = '<p class="text-amber-600">VOICEVOX ã‚’é¸æŠã—ã¾ã—ãŸãŒã€Engine ã«æ¥ç¶šã§ãã¦ã„ã¾ã›ã‚“ã€‚ä¸Šã§ã€ŒVOICEVOXã€ã‚’é¸ã³ç›´ã™ã‹ã€VOICEVOX Engine ã‚’èµ·å‹•ã—ã¦ãã ã•ã„ã€‚</p>';
                    return;
                }
                characters.forEach((char, index) => {
                    characterColors[char] = colors[index % colors.length];
                    const selectorDiv = document.createElement('div');
                    selectorDiv.className = 'flex items-center justify-between gap-4';
                    const label = document.createElement('label');
                    label.textContent = `${char}ã®å£°:`;
                    label.className = 'font-semibold flex-shrink-0';
                    label.style.color = characterColors[char];
                    const select = document.createElement('select');
                    select.className = 'w-full p-2 border rounded-md bg-white';
                    voicevoxSpeakers.forEach((s, i) => {
                        const option = document.createElement('option');
                        option.value = s.id;
                        option.textContent = s.displayName;
                        select.appendChild(option);
                    });
                    const initialId = voicevoxSpeakers[Math.min(index % voicevoxSpeakers.length, voicevoxSpeakers.length - 1)].id;
                    select.value = String(initialId);
                    characterVoicevoxIds[char] = initialId;
                    select.onchange = () => { characterVoicevoxIds[char] = parseInt(select.value, 10); };
                    selectorDiv.appendChild(label);
                    selectorDiv.appendChild(select);
                    voiceSelectors.appendChild(selectorDiv);
                });
                return;
            }

            if (japaneseVoices.length === 0) {
                voiceSelectors.innerHTML = '<p class="text-red-500">åˆ©ç”¨å¯èƒ½ãªéŸ³å£°ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</p>';
                return;
            }

            characters.forEach((char, index) => {
                characterColors[char] = colors[index % colors.length];

                const selectorDiv = document.createElement('div');
                selectorDiv.className = 'flex items-center justify-between gap-4';
                
                const label = document.createElement('label');
                label.textContent = `${char}ã®å£°:`;
                label.className = 'font-semibold flex-shrink-0';
                label.style.color = characterColors[char];

                const select = document.createElement('select');
                select.className = 'w-full p-2 border rounded-md bg-white';
                
                japaneseVoices.forEach((voice, vIndex) => {
                    const option = document.createElement('option');
                    option.value = vIndex;
                    option.textContent = voice.name;
                    select.appendChild(option);
                });

                const initialIndex = index % japaneseVoices.length;
                select.value = String(initialIndex);
                characterVoices[char] = japaneseVoices[initialIndex];

                select.onchange = () => {
                    const idx = parseInt(select.value, 10);
                    characterVoices[char] = japaneseVoices[idx];
                };
                
                selectorDiv.appendChild(label);
                selectorDiv.appendChild(select);
                voiceSelectors.appendChild(selectorDiv);
            });
        }

        function insertRowAfter(index) {
            const d = parseScriptFromEditor();
            d.splice(index + 1, 0, { character: '', line: '' });
            generatedDialogue = d;
            setupScriptEditor();
        }

        function appendRow() {
            const d = parseScriptFromEditor();
            d.push({ character: '', line: '' });
            generatedDialogue = d;
            setupScriptEditor();
        }

        function deleteRow(index) {
            const d = parseScriptFromEditor();
            if (d.length <= 1) {
                alert('æœ€å¾Œã®1è¡Œã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚');
                return;
            }
            d.splice(index, 1);
            generatedDialogue = d;
            setupScriptEditor();
        }

        function setupScriptEditor() {
            scriptEditor.innerHTML = '';
            generatedDialogue.forEach((item, index) => {
                const color = characterColors[item.character] || '#374151';

                const lineDiv = document.createElement('div');
                lineDiv.className = 'flex items-center gap-2 flex-wrap';

                const charInput = document.createElement('input');
                charInput.type = 'text';
                charInput.value = item.character;
                charInput.className = 'p-1 border-none rounded-md w-28 font-semibold text-white text-center';
                charInput.style.backgroundColor = color;
                charInput.setAttribute('data-index', index);
                charInput.setAttribute('data-type', 'character');
                charInput.placeholder = 'ã‚­ãƒ£ãƒ©å';

                const lineInput = document.createElement('input');
                lineInput.type = 'text';
                lineInput.value = item.line;
                lineInput.className = 'p-1 border rounded-md flex-grow min-w-[120px]';
                lineInput.style.borderLeft = `4px solid ${color}`;
                lineInput.setAttribute('data-index', index);
                lineInput.setAttribute('data-type', 'line');
                lineInput.placeholder = 'ã‚»ãƒªãƒ•';

                const copyButton = document.createElement('button');
                copyButton.title = 'ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼';
                copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg>`;
                copyButton.className = 'bg-gray-200 hover:bg-gray-300 p-2 rounded-md transition';
                copyButton.onclick = () => {
                    const textToCopy = lineInput.value;
                    const textArea = document.createElement('textarea');
                    textArea.value = textToCopy;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    copyButton.classList.add('text-green-500');
                    setTimeout(() => copyButton.classList.remove('text-green-500'), 1500);
                };

                const downloadBtn = document.createElement('button');
                downloadBtn.title = 'ã“ã®è¡Œã®éŸ³å£°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆVOICEVOXé¸æŠæ™‚ï¼‰';
                downloadBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" clip-rule="evenodd" /></svg>`;
                downloadBtn.className = 'bg-emerald-100 hover:bg-emerald-200 p-2 rounded-md transition text-emerald-800';
                downloadBtn.onclick = async () => {
                    const useVoicevox = document.querySelector('input[name="voice-engine"]:checked').value === 'voicevox';
                    if (!useVoicevox || voicevoxSpeakers.length === 0) {
                        alert('éŸ³å£°ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¯ã€ŒVOICEVOXï¼ˆãšã‚“ã ã‚‚ã‚“ç­‰ï¼‰ã€ã‚’é¸æŠã—ãŸçŠ¶æ…‹ã§åˆ©ç”¨ã§ãã¾ã™ã€‚');
                        return;
                    }
                    const char = charInput.value.trim() || 'è©±è€…';
                    const text = lineInput.value.trim();
                    if (!text) {
                        alert('ã‚»ãƒªãƒ•ãŒç©ºã§ã™ã€‚');
                        return;
                    }
                    const speakerId = characterVoicevoxIds[char] ?? voicevoxSpeakers[0].id;
                    downloadBtn.disabled = true;
                    downloadBtn.classList.add('opacity-50');
                    try {
                        const base = document.getElementById('voicevox-engine-url').value.trim().replace(/\/$/, '');
                        const queryRes = await fetch(`${base}/audio_query?text=${encodeURIComponent(text)}&speaker=${speakerId}`, { method: 'POST' });
                        if (!queryRes.ok) throw new Error('VOICEVOX ã«æ¥ç¶šã§ãã¾ã›ã‚“');
                        const query = await queryRes.json();
                        const synthRes = await fetch(`${base}/synthesis?speaker=${speakerId}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(query) });
                        if (!synthRes.ok) throw new Error('éŸ³å£°ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                        const blob = await synthRes.blob();
                        const format = document.querySelector('input[name="download-format"]:checked');
                        const useMp4 = format && format.value === 'mp4';
                        const baseName = `voice_${String(index + 1).padStart(3, '0')}_${char.replace(/[/\\?*:|"]/g, '_')}`;
                        let url, downloadName;
                        if (useMp4) {
                            const ctx = new (window.AudioContext || window.webkitAudioContext)();
                            const buf = await ctx.decodeAudioData(await blob.arrayBuffer());
                            const mp4Blob = await audioBufferToMp4Blob(buf);
                            url = URL.createObjectURL(mp4Blob);
                            downloadName = baseName + '.mp4';
                        } else {
                            url = URL.createObjectURL(blob);
                            downloadName = baseName + '.wav';
                        }
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = downloadName;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    } catch (e) {
                        console.error(e);
                        alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚VOICEVOX Engine ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    } finally {
                        downloadBtn.disabled = false;
                        downloadBtn.classList.remove('opacity-50');
                    }
                };

                const insertDialogueBtn = document.createElement('button');
                insertDialogueBtn.type = 'button';
                insertDialogueBtn.textContent = 'ä¸‹ã«ã‚»ãƒªãƒ•';
                insertDialogueBtn.title = 'ã“ã®è¡Œã®ç›´ä¸‹ã«ã‚»ãƒªãƒ•è¡Œã‚’æŒ¿å…¥';
                insertDialogueBtn.className = 'text-xs px-2 py-1 bg-blue-100 hover:bg-blue-200 rounded text-blue-800';
                insertDialogueBtn.onclick = () => insertRowAfter(index);

                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.textContent = 'å‰Šé™¤';
                deleteBtn.title = 'ã“ã®è¡Œã‚’å‰Šé™¤';
                deleteBtn.className = 'text-xs px-2 py-1 bg-red-100 hover:bg-red-200 rounded text-red-800';
                deleteBtn.onclick = () => deleteRow(index);

                lineDiv.appendChild(charInput);
                lineDiv.appendChild(lineInput);
                lineDiv.appendChild(copyButton);
                lineDiv.appendChild(downloadBtn);
                lineDiv.appendChild(insertDialogueBtn);
                lineDiv.appendChild(deleteBtn);
                scriptEditor.appendChild(lineDiv);
            });

            const endRow = document.createElement('div');
            endRow.className = 'flex items-center gap-2 mt-2 pt-2 border-t border-gray-200';
            const addDialogueBtn = document.createElement('button');
            addDialogueBtn.type = 'button';
            addDialogueBtn.textContent = 'è¡Œã‚’è¿½åŠ ';
            addDialogueBtn.title = 'æ–°ã—ã„ã‚»ãƒªãƒ•è¡Œã‚’æœ«å°¾ã«è¿½åŠ ï¼ˆã‚­ãƒ£ãƒ©åãƒ»ã‚»ãƒªãƒ•ã‚’å…¥åŠ›ã™ã‚‹ã¨ãã®ãƒ¡ãƒ³ãƒãƒ¼ãŒèª­ã¿ä¸Šã’ã¾ã™ï¼‰';
            addDialogueBtn.className = 'px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md text-sm font-medium';
            addDialogueBtn.onclick = () => appendRow();
            endRow.appendChild(addDialogueBtn);
            scriptEditor.appendChild(endRow);
        }

        // Playback Logic
        playFullAdBtn.addEventListener('click', () => {
            if (isPlaying) {
                stopFullAd();
            } else {
                const activeElement = document.activeElement;
                let startingIndex = 0;
                if (activeElement && activeElement.parentElement.parentElement === scriptEditor && activeElement.hasAttribute('data-index')) {
                    startingIndex = parseInt(activeElement.getAttribute('data-index'), 10);
                }
                startFullAd(startingIndex);
            }
        });

        function parseScriptFromEditor() {
            const newDialogue = [];
            const lineDivs = scriptEditor.querySelectorAll('div');
            lineDivs.forEach(div => {
                const charInput = div.querySelector('input[data-type="character"]');
                const lineInput = div.querySelector('input[data-type="line"]');
                if (charInput && lineInput) {
                    newDialogue.push({
                        character: charInput.value,
                        line: lineInput.value
                    });
                }
            });
            return newDialogue;
        }
        
        async function startFullAd(startingIndex = 0) {
            generatedDialogue = parseScriptFromEditor();
            if (generatedDialogue.length === 0) return;
            
            isPlaying = true;
            playFullAdBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 00-1 1v2a1 1 0 001 1h6a1 1 0 001-1V9a1 1 0 00-1-1H7z" clip-rule="evenodd" /></svg>åœæ­¢ã™ã‚‹`;
            
            const imageSources = sourceFiles.filter(f => f.fileType === 'image');
            let imageIndex = 0;
            if (imageSlideshowInterval) clearInterval(imageSlideshowInterval);
            imageSlideshowInterval = null;
            if (currentMode === 'file' && imageSources.length > 1) {
                imageSlideshowInterval = setInterval(() => {
                    imageIndex = (imageIndex + 1) % imageSources.length;
                    resultImage.style.opacity = 0;
                    setTimeout(() => {
                        resultImage.src = imageSources[imageIndex].base64;
                        resultImage.style.opacity = 1;
                        imageCounter.textContent = `ç”»åƒ ${imageIndex + 1} / ${imageSources.length}`;
                    }, 500);
                }, 3000);
            }

            currentLineIndex = startingIndex;
            speakFullAd();
        }

        function stopFullAd() {
            isPlaying = false;
            synth.cancel();
            if (currentVoicevoxAudio) {
                currentVoicevoxAudio.onended = null;
                currentVoicevoxAudio.onerror = null;
                currentVoicevoxAudio.pause();
                currentVoicevoxAudio.src = '';
                currentVoicevoxAudio = null;
            }
            if (imageSlideshowInterval) {
                clearInterval(imageSlideshowInterval);
                imageSlideshowInterval = null;
            }
            playFullAdBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>ã“ã“ã‹ã‚‰å†ç”Ÿ`;
            const imageSources = sourceFiles.filter(f => f.fileType === 'image');
            if (currentMode === 'file' && imageSources.length > 0) {
                resultImage.src = imageSources[0].base64;
                resultImage.style.opacity = 1;
                imageCounter.textContent = `ç”»åƒ 1 / ${imageSources.length}`;
            }
        }

        // ãƒ–ãƒ©ã‚¦ã‚¶ã®éŸ³å£°ãŒã€Œå–‹ã‚Šçµ‚ã‚ã£ãŸã€ã¨åˆ¤å®šã•ã‚Œã‚‹ã¾ã§å¾…ã¤ï¼ˆonend ãŒæ—©ãå‡ºã‚‹å ´åˆã®å¯¾ç­–ï¼‰
        function waitUntilSpeechEnd() {
            return new Promise(resolve => {
                const check = () => {
                    if (!isPlaying) { resolve(); return; }
                    if (!synth.speaking) {
                        setTimeout(() => resolve(), 200);
                        return;
                    }
                    setTimeout(check, 100);
                };
                check();
            });
        }

        async function speakFullAd() {
            if (currentLineIndex >= generatedDialogue.length || !isPlaying) {
                stopFullAd();
                return;
            }
            lineAdvanceScheduled = false;

            const item = generatedDialogue[currentLineIndex];
            if (!item.line || !String(item.line).trim()) {
                currentLineIndex++;
                setTimeout(speakFullAd, 0);
                return;
            }
            const useVoicevox = document.querySelector('input[name="voice-engine"]:checked').value === 'voicevox';

            if (useVoicevox && voicevoxSpeakers.length > 0) {
                const speakerId = characterVoicevoxIds[item.character] ?? voicevoxSpeakers[0].id;
                try {
                    const blobUrl = await voicevoxSynthesize(item.line, speakerId);
                    if (!isPlaying) return;
                    if (currentVoicevoxAudio) {
                        currentVoicevoxAudio.onended = null;
                        currentVoicevoxAudio.onerror = null;
                        currentVoicevoxAudio.pause();
                        currentVoicevoxAudio.src = '';
                        currentVoicevoxAudio = null;
                    }
                    currentVoicevoxAudio = new Audio(blobUrl);
                    currentVoicevoxAudio.onended = () => {
                        if (lineAdvanceScheduled) return;
                        lineAdvanceScheduled = true;
                        URL.revokeObjectURL(blobUrl);
                        currentLineIndex++;
                        setTimeout(speakFullAd, 350);
                    };
                    currentVoicevoxAudio.onerror = (e) => {
                        if (lineAdvanceScheduled) return;
                        lineAdvanceScheduled = true;
                        console.error('VOICEVOX playback error', e);
                        URL.revokeObjectURL(blobUrl);
                        currentLineIndex++;
                        setTimeout(speakFullAd, 350);
                    };
                    currentVoicevoxAudio.play();
                } catch (e) {
                    console.error('VOICEVOX synthesize error', e);
                    currentLineIndex++;
                    setTimeout(speakFullAd, 500);
                }
                return;
            }

            synth.cancel();
            const utterance = new SpeechSynthesisUtterance(item.line);
            if (characterVoices[item.character]) {
                utterance.voice = characterVoices[item.character];
            } else {
                const firstVoice = japaneseVoices[0];
                if (firstVoice) utterance.voice = firstVoice;
            }
            utterance.onend = () => {
                if (lineAdvanceScheduled) return;
                lineAdvanceScheduled = true;
                waitUntilSpeechEnd().then(() => {
                    currentLineIndex++;
                    speakFullAd();
                });
            };
            utterance.onerror = (e) => {
                if (lineAdvanceScheduled) return;
                lineAdvanceScheduled = true;
                console.error('SpeechSynthesisUtterance.onerror', e);
                waitUntilSpeechEnd().then(() => {
                    currentLineIndex++;
                    speakFullAd();
                });
            };
            synth.speak(utterance);
        }

        // CSV Import/Export Logic
        importCsvBtn.addEventListener('click', () => {
            csvImportInput.click();
        });

        csvImportInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const dialogue = parseCSV(text);
                if (!dialogue || dialogue.length === 0) {
                    alert('CSVã«æœ‰åŠ¹ãªå°æœ¬ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚1è¡Œç›®ã¯è¦‹å‡ºã—ï¼ˆcharacter,lineï¼‰ã€2è¡Œç›®ä»¥é™ã«ã€Œã‚­ãƒ£ãƒ©å,ã‚»ãƒªãƒ•ã€ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚');
                    event.target.value = '';
                    return;
                }
                clearFilesBtn.click();
                urlInput.value = '';
                scenarioDetail.value = 'CSVã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ';
                displayResults({ dialogue });
                resultSection.scrollIntoView({ behavior: 'smooth' });
            };
            reader.readAsText(file);
        });

        exportCsvBtn.addEventListener('click', () => {
            const dialogue = parseScriptFromEditor();
            if (dialogue.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹å°æœ¬ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            const csvContent = generateCSV(dialogue);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'script.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        downloadFullAudioBtn.addEventListener('click', async () => {
            const dialogue = parseScriptFromEditor();
            if (dialogue.length === 0) {
                alert('å°æœ¬ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            const useVoicevox = document.querySelector('input[name="voice-engine"]:checked').value === 'voicevox';
            if (!useVoicevox || voicevoxSpeakers.length === 0) {
                alert('ã€ŒéŸ³å£°ã‚’ã¾ã¨ã‚ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã¯ VOICEVOX é¸æŠæ™‚ã®ã¿åˆ©ç”¨ã§ãã¾ã™ã€‚');
                return;
            }
            const base = document.getElementById('voicevox-engine-url').value.trim().replace(/\/$/, '');
            const GAP_SEC = 0.2;
            downloadFullAudioBtn.disabled = true;
            downloadFullAudioBtn.textContent = 'ç”Ÿæˆä¸­...';
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const buffers = [];
                let sampleRate = 24000;
                let numChannels = 1;
                for (let i = 0; i < dialogue.length; i++) {
                    const d = dialogue[i];
                    const speakerId = characterVoicevoxIds[d.character] ?? voicevoxSpeakers[0].id;
                    const text = d.line.trim();
                    if (!text) continue;
                    const queryRes = await fetch(`${base}/audio_query?text=${encodeURIComponent(text)}&speaker=${speakerId}`, { method: 'POST' });
                    if (!queryRes.ok) throw new Error(`è¡Œ ${i + 1} ã®å–å¾—ã«å¤±æ•—`);
                    const query = await queryRes.json();
                    const synthRes = await fetch(`${base}/synthesis?speaker=${speakerId}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(query) });
                    if (!synthRes.ok) throw new Error(`è¡Œ ${i + 1} ã®éŸ³å£°ç”Ÿæˆã«å¤±æ•—`);
                    const blob = await synthRes.blob();
                    const buf = await ctx.decodeAudioData(await blob.arrayBuffer());
                    sampleRate = buf.sampleRate;
                    numChannels = buf.numberOfChannels;
                    buffers.push(buf);
                }
                if (buffers.length === 0) throw new Error('æœ‰åŠ¹ãªã‚»ãƒªãƒ•ãŒã‚ã‚Šã¾ã›ã‚“');
                sampleRate = buffers[0].sampleRate;
                numChannels = buffers[0].numberOfChannels;
                const totalSamples = buffers.reduce((acc, b) => acc + b.length, 0) + Math.round(GAP_SEC * sampleRate) * (buffers.length - 1);
                const offline = new OfflineAudioContext(numChannels, totalSamples, sampleRate);
                let offset = 0;
                for (let i = 0; i < buffers.length; i++) {
                    const src = offline.createBufferSource();
                    src.buffer = buffers[i];
                    src.connect(offline.destination);
                    src.start(offset);
                    offset += buffers[i].length / sampleRate + GAP_SEC;
                }
                const rendered = await offline.startRendering();
                const format = document.querySelector('input[name="download-format"]:checked').value;
                let blob, filename;
                if (format === 'mp4') {
                    blob = await audioBufferToMp4Blob(rendered);
                    filename = 'script_full_audio.mp4';
                } else {
                    const wav = audioBufferToWav(rendered);
                    blob = new Blob([wav], { type: 'audio/wav' });
                    filename = 'script_full_audio.wav';
                }
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                console.error(e);
                alert('ã¾ã¨ã‚ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚' + (e.message || ''));
            } finally {
                downloadFullAudioBtn.disabled = false;
                downloadFullAudioBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" clip-rule="evenodd" /></svg>éŸ³å£°ã‚’ã¾ã¨ã‚ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰`;
            }
        });

        bgmFileSelectBtn.addEventListener('click', () => bgmFileInput.click());
        bgmFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            bgmFileName.textContent = file ? file.name : 'æœªé¸æŠ';
        });
        bgmVolumeSlider.addEventListener('input', () => {
            bgmVolumeValue.textContent = bgmVolumeSlider.value;
        });

        downloadWithBgmBtn.addEventListener('click', async () => {
            const dialogue = parseScriptFromEditor();
            if (dialogue.length === 0) {
                alert('å°æœ¬ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            const useVoicevox = document.querySelector('input[name="voice-engine"]:checked').value === 'voicevox';
            if (!useVoicevox || voicevoxSpeakers.length === 0) {
                alert('ã€ŒBGMã‚’ä»˜ã‘ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã¯ VOICEVOX é¸æŠæ™‚ã®ã¿åˆ©ç”¨ã§ãã¾ã™ã€‚');
                return;
            }
            if (!bgmFileInput.files || !bgmFileInput.files[0]) {
                alert('BGMãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            const base = document.getElementById('voicevox-engine-url').value.trim().replace(/\/$/, '');
            const GAP_SEC = 0.2;
            const bgmGain = parseInt(bgmVolumeSlider.value, 10) / 100;
            downloadWithBgmBtn.disabled = true;
            downloadWithBgmBtn.textContent = 'ç”Ÿæˆä¸­...';
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const buffers = [];
                let sampleRate = 24000;
                let numChannels = 1;
                for (let i = 0; i < dialogue.length; i++) {
                    const d = dialogue[i];
                    const speakerId = characterVoicevoxIds[d.character] ?? voicevoxSpeakers[0].id;
                    const text = d.line.trim();
                    if (!text) continue;
                    const queryRes = await fetch(`${base}/audio_query?text=${encodeURIComponent(text)}&speaker=${speakerId}`, { method: 'POST' });
                    if (!queryRes.ok) throw new Error(`è¡Œ ${i + 1} ã®å–å¾—ã«å¤±æ•—`);
                    const query = await queryRes.json();
                    const synthRes = await fetch(`${base}/synthesis?speaker=${speakerId}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(query) });
                    if (!synthRes.ok) throw new Error(`è¡Œ ${i + 1} ã®éŸ³å£°ç”Ÿæˆã«å¤±æ•—`);
                    const blob = await synthRes.blob();
                    const buf = await ctx.decodeAudioData(await blob.arrayBuffer());
                    sampleRate = buf.sampleRate;
                    numChannels = buf.numberOfChannels;
                    buffers.push(buf);
                }
                if (buffers.length === 0) throw new Error('æœ‰åŠ¹ãªã‚»ãƒªãƒ•ãŒã‚ã‚Šã¾ã›ã‚“');
                sampleRate = buffers[0].sampleRate;
                numChannels = buffers[0].numberOfChannels;
                const totalSamples = buffers.reduce((acc, b) => acc + b.length, 0) + Math.round(GAP_SEC * sampleRate) * (buffers.length - 1);
                const offlineVoice = new OfflineAudioContext(numChannels, totalSamples, sampleRate);
                let offset = 0;
                for (let i = 0; i < buffers.length; i++) {
                    const src = offlineVoice.createBufferSource();
                    src.buffer = buffers[i];
                    src.connect(offlineVoice.destination);
                    src.start(offset);
                    offset += buffers[i].length / sampleRate + GAP_SEC;
                }
                const voiceBuffer = await offlineVoice.startRendering();

                const bgmArrayBuffer = await bgmFileInput.files[0].arrayBuffer();
                const bgmBuffer = await ctx.decodeAudioData(bgmArrayBuffer);

                const outChannels = Math.max(voiceBuffer.numberOfChannels, bgmBuffer.numberOfChannels);
                const outLength = voiceBuffer.length;
                const outSampleRate = voiceBuffer.sampleRate;
                const offlineMix = new OfflineAudioContext(outChannels, outLength, outSampleRate);

                const voiceSrc = offlineMix.createBufferSource();
                voiceSrc.buffer = voiceBuffer;
                voiceSrc.connect(offlineMix.destination);
                voiceSrc.start(0);

                const voiceDurationSec = voiceBuffer.length / outSampleRate;
                const fadeOutSec = Math.min(2, voiceDurationSec * 0.5);

                const bgmSrc = offlineMix.createBufferSource();
                bgmSrc.buffer = bgmBuffer;
                bgmSrc.loop = true;
                const bgmGainNode = offlineMix.createGain();
                bgmGainNode.gain.setValueAtTime(bgmGain, 0);
                bgmGainNode.gain.linearRampToValueAtTime(bgmGain, Math.max(0, voiceDurationSec - fadeOutSec));
                bgmGainNode.gain.linearRampToValueAtTime(0, voiceDurationSec);
                bgmSrc.connect(bgmGainNode);
                bgmGainNode.connect(offlineMix.destination);
                bgmSrc.start(0);

                const mixed = await offlineMix.startRendering();
                const format = document.querySelector('input[name="download-format"]:checked').value;
                let blob, filename;
                if (format === 'mp4') {
                    blob = await audioBufferToMp4Blob(mixed);
                    filename = 'script_full_audio_with_bgm.mp4';
                } else {
                    const wav = audioBufferToWav(mixed);
                    blob = new Blob([wav], { type: 'audio/wav' });
                    filename = 'script_full_audio_with_bgm.wav';
                }
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                console.error(e);
                alert('BGMä»˜ããƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚' + (e.message || ''));
            } finally {
                downloadWithBgmBtn.disabled = false;
                downloadWithBgmBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" clip-rule="evenodd" /></svg>BGMã‚’ä»˜ã‘ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰`;
            }
        });

        function audioBufferToWav(buffer) {
            const numCh = buffer.numberOfChannels;
            const sr = buffer.sampleRate;
            const length = buffer.length * numCh * 2;
            const arrayBuffer = new ArrayBuffer(44 + length);
            const view = new DataView(arrayBuffer);
            const writeStr = (offset, str) => { for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i)); };
            writeStr(0, 'RIFF');
            view.setUint32(4, 36 + length, true);
            writeStr(8, 'WAVE');
            writeStr(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numCh, true);
            view.setUint32(24, sr, true);
            view.setUint32(28, sr * numCh * 2, true);
            view.setUint16(32, numCh * 2, true);
            view.setUint16(34, 16, true);
            writeStr(36, 'data');
            view.setUint32(40, length, true);
            let pos = 44;
            for (let i = 0; i < buffer.length; i++) {
                for (let ch = 0; ch < numCh; ch++) {
                    const v = Math.max(-1, Math.min(1, buffer.getChannelData(ch)[i]));
                    view.setInt16(pos, v < 0 ? v * 0x8000 : v * 0x7FFF, true);
                    pos += 2;
                }
            }
            return arrayBuffer;
        }

        /** AudioBuffer ã‚’ MediaRecorder ã§ MP4ï¼ˆã¾ãŸã¯ M4Aï¼‰Blob ã«å¤‰æ› */
        function audioBufferToMp4Blob(audioBuffer) {
            return new Promise((resolve, reject) => {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const dest = ctx.createMediaStreamDestination();
                const src = ctx.createBufferSource();
                src.buffer = audioBuffer;
                src.connect(dest);
                let stream = dest.stream;
                let mimeType = 'audio/mp4';
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'video/mp4';
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        reject(new Error('MP4å½¢å¼ã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚WAVã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚'));
                        return;
                    }
                    const canvas = document.createElement('canvas');
                    canvas.width = 640;
                    canvas.height = 360;
                    const g = canvas.getContext('2d');
                    g.fillStyle = '#000';
                    g.fillRect(0, 0, canvas.width, canvas.height);
                    const videoStream = canvas.captureStream(0);
                    stream = new MediaStream([...dest.stream.getAudioTracks(), ...videoStream.getVideoTracks()]);
                }
                const recorder = new MediaRecorder(stream, { mimeType });
                const chunks = [];
                recorder.ondataavailable = (e) => { if (e.data.size) chunks.push(e.data); };
                recorder.onstop = () => resolve(new Blob(chunks, { type: mimeType }));
                recorder.onerror = (e) => reject(e.error || new Error('MP4ã®éŒ²éŸ³ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                recorder.start(100);
                src.onended = () => recorder.stop();
                src.start(0);
            });
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(l => l.trim());
            const dialogue = [];
            // Skip header
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                const firstCommaIndex = line.indexOf(',');
                if (firstCommaIndex === -1) continue;
                
                const character = line.substring(0, firstCommaIndex).trim().replace(/"/g, '');
                let lineText = line.substring(firstCommaIndex + 1).trim();
                
                if (lineText.startsWith('"') && lineText.endsWith('"')) {
                    lineText = lineText.substring(1, lineText.length - 1).replace(/""/g, '"');
                }
                dialogue.push({ character, line: lineText });
            }
            return dialogue;
        }

        function generateCSV(dialogue) {
            let csvRows = ['"character","line"'];
            dialogue.forEach(item => {
                const character = `"${item.character.replace(/"/g, '""')}"`;
                const line = `"${item.line.replace(/"/g, '""')}"`;
                csvRows.push([character, line].join(','));
            });
            return csvRows.join('\n');
        }

        // Translate Logic
        translateBtn.addEventListener('click', async () => {
            const dialogue = parseScriptFromEditor();
            if (dialogue.length === 0) {
                alert('ç¿»è¨³ã™ã‚‹å°æœ¬ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            const targetLanguage = translateLanguage.value;
            const originalText = dialogue.map(d => `${d.character}: ${d.line}`).join('\n');
            
            loading.classList.remove('hidden');
            loading.classList.add('flex');
            loadingText.textContent = `${targetLanguage}ã«ç¿»è¨³ä¸­ã§ã™...`;
            translateBtn.disabled = true;

            try {
                const characters = [...new Set(dialogue.map(item => item.character))].join(', ');
                const prompt = `ä»¥ä¸‹ã®å°æœ¬ã‚’ã€${targetLanguage}ã€‘ã«ç¿»è¨³ã—ã¦ãã ã•ã„ã€‚ç™»å ´äººç‰©ã®åå‰ï¼ˆ${characters}ï¼‰ã¯å¤‰æ›´ã›ãšã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€Œç™»å ´äººç‰©: ã‚»ãƒªãƒ•ã€ã‚’ç¶­æŒã—ã¦ãã ã•ã„ã€‚\n\n${originalText}`;
                const translatedText = await callGemini([{ text: prompt }]);
                
                const translatedDialogue = translatedText.split('\n').filter(line => line.trim() !== '').map(line => {
                    const colonIndex = line.indexOf(':');
                    if (colonIndex === -1) return { character: '?', line: line.trim() };
                    return {
                        character: line.substring(0, colonIndex).trim(),
                        line: line.substring(colonIndex + 1).trim()
                    };
                });

                if (translatedDialogue.length === 0) {
                    throw new Error('ç¿»è¨³çµæœã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
                }
                displayResults({ dialogue: translatedDialogue });

            } catch (error) {
                console.error('Translation failed:', error);
                alert('ç¿»è¨³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            } finally {
                loading.classList.add('hidden');
                loading.classList.remove('flex');
                translateBtn.disabled = false;
            }
        });

        document.getElementById('spec-toggle-btn').addEventListener('click', () => {
            const content = document.getElementById('spec-content');
            const icon = document.getElementById('spec-toggle-icon');
            content.classList.toggle('hidden');
            icon.textContent = content.classList.contains('hidden') ? 'â–¼' : 'â–²';
        });

        // PWA: å¸¸ã«æœ€æ–°ç‰ˆã§é–‹ãï¼ˆService Worker ç™»éŒ²ãƒ»æ›´æ–°æ™‚ãƒªãƒ­ãƒ¼ãƒ‰ï¼‰
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js', { updateViaCache: 'none' })
                .then((reg) => {
                    reg.onupdatefound = () => {
                        const newWorker = reg.installing;
                        newWorker.onstatechange = () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                newWorker.postMessage({ type: 'SKIP_WAITING' });
                            }
                        };
                    };
                    if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                })
                .catch((err) => console.warn('Service Worker ç™»éŒ²å¤±æ•—:', err));
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                window.location.reload();
            });
        }
    </script>
</body>
</html>
